

<!DOCTYPE html>


<html lang="en" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>Lectura 8-1: Diagnóstico de modelos &#8212; MEL 202302</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=e353d410970836974a52" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=e353d410970836974a52" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" href="../_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=e353d410970836974a52" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52" />

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'Week_8/8-1-diagnostics';</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Lectura 8-2: Transformaciones" href="8-2-transformations.html" />
    <link rel="prev" title="&lt;no title&gt;" href="8-0-Schedule_week_8.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
  

<a class="navbar-brand logo" href="../Syllabus.html">
  
  
  
  
  
    <p class="title logo__title">MEL 202302</p>
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../Syllabus.html">
                    Syllabus
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Semana 1</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../Week_1/1-0-Schedule_week_1.html">Semana 1. Introducción al análisis estadístico</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Week_1/1-1-Introduction_pensamiento_stat.html">Lectura 1-1: Introducción al Pensamiento estadístico</a></li>




<li class="toctree-l1"><a class="reference internal" href="../Week_1/1-2-Estad%C3%ADstica_descriptiva.html">Lectura 1-2:  Estadística Descriptiva</a></li>








<li class="toctree-l1"><a class="reference internal" href="../Week_1/1-3-Visualizations.html">Lectura 1-3: Visualización de datos con Python</a></li>




</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Semana 2</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../Week_2/2-0-Schedule_week_2.html">Semana 2. Probabilidad y distribuciones Probabilidad y Distribuciones</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Week_2/2-1-Prob.html">Lectura 2-1: Probabilidad y estadística</a></li>





</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Semana 3</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../Week_3/3-1-Inference.html">Lectura 3-1: Inferencia estadística</a></li>

<li class="toctree-l1"><a class="reference internal" href="../Week_3/3-2-Hypothesis.html">Lectura 3-2: Pruebas de Hipotesis</a></li>







<li class="toctree-l1"><a class="reference internal" href="../Week_3/3-3-Hypothesis_2.html">Lectura 3-3: Pruebas de Hipotesis 2.</a></li>

</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Semana 4</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../Week_4/4-1%20Correlaciones.html">Lectura 4-1: Correlaciones</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Week_4/4-2-Simple_linear_regression.html">Lectura 4-2: Regresión lineal simple</a></li>




<li class="toctree-l1"><a class="reference internal" href="../Week_4/4-3-SLR_supuestos.html">Lectura 4-3: Supuestos de la regresión lineal simple</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Semana 5</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../Week_5/5-2-Hypothesis_Confidence.html">Lectura 5-1: Inferencia en RLS</a></li>









</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Semana 7</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../Week_7/7-1-Multiple_linear_regresion.html">Lectura 7-1: Regresión Lineal Múltiple</a></li>




<li class="toctree-l1"><a class="reference internal" href="../Week_7/7-2-Categorical_variables.html">Lectura 7-2: Predictores categóricos e interacciones</a></li>





</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Semana 8</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Lectura 8-1: Diagnóstico de modelos</a></li>




<li class="toctree-l1"><a class="reference internal" href="8-2-transformations.html">Lectura 8-2: Transformaciones</a></li>




<li class="toctree-l1"><a class="reference internal" href="8-3-collinearity.html">Lectura 8-3: Colinealidad</a></li>


</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://colab.research.google.com/github/tabarespozos/MEL_202302/blob/MEL_202302/Week_8/8-1-diagnostics.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch onColab"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img src="../_static/images/logo_colab.png">
  </span>
<span class="btn__text-container">Colab</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/tabarespozos/MEL_202302" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/tabarespozos/MEL_202302/issues/new?title=Issue%20on%20page%20%2FWeek_8/8-1-diagnostics.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/Week_8/8-1-diagnostics.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>


<script>
document.write(`
  <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
  </button>
`);
</script>

<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Lectura 8-1: Diagnóstico de modelos</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">Lectura 8-1: Diagnóstico de modelos</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#supuestos-del-modelo">Supuestos del modelo</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#comprobacion-de-supuestos">Comprobación de supuestos</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#grafico-de-ajuste-frente-a-residuos">Gráfico de ajuste frente a residuos</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#prueba-de-breusch-pagan">Prueba de Breusch-Pagan</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#histogramas">Histogramas</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#graficos-q-q">Gráficos Q-Q</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#prueba-de-shapiro-wilk">Prueba de Shapiro-Wilk</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#observaciones-inusuales">Observaciones inusuales</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#apalancamiento">Apalancamiento</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#valores-atipicos">Valores atípicos</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#influencia">Influencia</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#ejemplos-de-analisis-de-datos">Ejemplos de análisis de datos</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#buenos-diagnosticos">Buenos diagnósticos</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#diagnosticos-sospechosos">Diagnósticos sospechosos</a></li>
</ul>
</li>
</ul>

            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <section id="lectura-8-1-diagnostico-de-modelos">
<h1>Lectura 8-1: Diagnóstico de modelos<a class="headerlink" href="#lectura-8-1-diagnostico-de-modelos" title="Permalink to this heading">#</a></h1>
</section>
<section id="supuestos-del-modelo">
<h1>Supuestos del modelo<a class="headerlink" href="#supuestos-del-modelo" title="Permalink to this heading">#</a></h1>
<p>Recuerde el modelo de regresión lineal múltiple que hemos definido.</p>
<div class="math notranslate nohighlight">
\[ Y_i = \beta_0 + \beta_1 x_{i1} + \beta_2 x_{i2} + \cdots + \beta_{p-1} x_{i(p-1)} + \epsilon_i, \qquad i = 1, 2, \ldots, n. \]</div>
<p>Utilizando la notación matricial, este modelo puede escribirse de forma mucho más sucinta como</p>
<div class="math notranslate nohighlight">
\[Y = X \beta + \epsilon. \]</div>
<p>Dados los datos, hallamos las estimaciones de los parámetros <span class="math notranslate nohighlight">\(\beta\)</span> utilizando</p>
<div class="math notranslate nohighlight">
\[ \hat{\beta} = \left(  X^\top X  \right)^{-1}X^\top y. \]</div>
<p>A continuación, observamos que estas estimaciones tenían medias
$<span class="math notranslate nohighlight">\(\text{E}[\hat{\beta}] = \beta,\)</span>$</p>
<p>y varianza</p>
<div class="math notranslate nohighlight">
\[\text{Var}[\hat{\beta}] = \sigma^2 \left(  X^\top X  \right)^{-1}.\]</div>
<p>En particular, un parámetro individual, digamos <span class="math notranslate nohighlight">\(\hat{\beta}_j\)</span> tenía una distribución normal</p>
<div class="math notranslate nohighlight">
\[ \hat{\beta}_j \sim N\left(\beta_j, \sigma^2 C_{jj}  \right) \]</div>
<p>donde <span class="math notranslate nohighlight">\(C\)</span> era la matriz definida como</p>
<div class="math notranslate nohighlight">
\[C = \left(X^\top X\right)^{-1}.\]</div>
<p>A continuación, utilizamos este hecho para definir</p>
<div class="math notranslate nohighlight">
\[\frac{\hat{\beta}_j - \beta_j}{s_e \sqrt{C_{jj}}} \sim t_{n-p}, \]</div>
<p>que utilizamos para realizar pruebas de hipótesis.</p>
<p>Hasta ahora hemos analizado varias métricas como RMSE, RSE y <span class="math notranslate nohighlight">\(R^2\)</span> para determinar lo bien que nuestro modelo se ajusta a nuestros datos. Cada uno de ellos considera de alguna manera la expresión</p>
<div class="math notranslate nohighlight">
\[\sum_{i = 1}^n (y_i - \hat{y}_i)^2.\]</div>
<p>Esencialmente, cada uno de ellos analiza la proximidad de los puntos de datos al modelo. Sin embargo, ¿es eso lo único que nos importa?</p>
<ul class="simple">
<li><p>Podría ser que los errores se cometieran de forma sistemática, lo que significa que nuestro modelo está mal especificado. Es posible que necesitemos términos de interacción adicionales, o términos polinómicos que veremos más adelante.</p></li>
<li><p>También es posible que en un determinado conjunto de valores predictores, los errores sean muy pequeños, pero en un conjunto diferente de valores predictores, los errores sean grandes.</p></li>
<li><p>Tal vez la mayoría de los errores sean muy pequeños, pero algunos son muy grandes. Esto sugeriría que los errores no siguen una distribución normal.</p></li>
</ul>
<p>¿Son éstas cuestiones que nos preocupan? Si lo único que queremos es predecir, posiblemente no, ya que sólo nos importaría el tamaño de nuestros errores. Sin embargo, si quisiéramos realizar una inferencia, por ejemplo para determinar si un predictor concreto es importante, sí nos importan mucho. Todos los resultados distribucionales, como una prueba <span class="math notranslate nohighlight">\(t\)</span> para un único predictor, se derivan bajo los supuestos de nuestro modelo.</p>
<p>Técnicamente, los supuestos del modelo se codifican directamente en una declaración de modelo como,</p>
<div class="math notranslate nohighlight">
\[ Y_i = \beta_0 + \beta_1 x_{i1} + \beta_2 x_{i2} + \cdots + \beta_{p-1} x_{i(p-1)} + \epsilon_i\]</div>
<p>donde <span class="math notranslate nohighlight">\(\epsilon_i \sim N(0, \sigma^2).\)</span></p>
<p>A menudo, las <strong>suposiciones de la regresión lineal</strong>, se enuncian como,</p>
<ul class="simple">
<li><p><strong>L</strong>inealidad: la respuesta puede escribirse como una combinación lineal de los predictores. (Con ruido sobre esta verdadera relación lineal).</p></li>
<li><p><strong>I</strong>independencia: los errores son independientes.</p></li>
<li><p><strong>N</strong>ormalidad: la distribución de los errores debe seguir una distribución normal.</p></li>
<li><p><strong>I</strong>gual varianza: la varianza del error es la misma para cualquier conjunto de valores predictores.</p></li>
</ul>
<p>La hipótesis de linealidad se codifica como</p>
<div class="math notranslate nohighlight">
\[\beta_0 + \beta_1 x_{i1} + \beta_2 x_{i2} + \cdots + \beta_{p-1} x_{i(p-1)}, \]</div>
<p>mientras que los tres restantes están codificados en</p>
<div class="math notranslate nohighlight">
\[\epsilon_i \sim N(0, \sigma^2),\]</div>
<p>ya que las <span class="math notranslate nohighlight">\(\epsilon_i\)</span> son <span class="math notranslate nohighlight">\(iid\)</span> variables aleatorias normales con varianza constante.</p>
<p>Si se cumplen estos supuestos, ¡genial! Podemos realizar la inferencia, <strong>y es válida</strong>. Si estos supuestos <em>no</em> se cumplen, aún podemos “realizar” una prueba <span class="math notranslate nohighlight">\(t\)</span> utilizando <code class="docutils literal notranslate"><span class="pre">Python</span></code>, pero los resultados <strong>no son válidos</strong>. Las distribuciones de las estimaciones de los parámetros no serán las que esperamos. Las pruebas de hipótesis se aceptarán o rechazarán incorrectamente. Esencialmente, “basura dentro, basura fuera”.</p>
</section>
<section id="comprobacion-de-supuestos">
<h1>Comprobación de supuestos<a class="headerlink" href="#comprobacion-de-supuestos" title="Permalink to this heading">#</a></h1>
<p>Ahora veremos una serie de herramientas para comprobar los supuestos de un modelo lineal. Para probar estas herramientas, utilizaremos datos simulados de tres modelos:</p>
<div class="math notranslate nohighlight">
\[ Y = 3 + 5x + , N(0, 1) \]</div>
<div class="math notranslate nohighlight">
\[ Y = 3 + 5x + , N(0, x^2) \]</div>
<div class="math notranslate nohighlight">
\[ Y = 3 + 5x^2 + , N(0, 25) \]</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">LinearRegression</span>
<span class="n">sns</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="s1">&#39;whitegrid&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">sim_1</span><span class="p">(</span><span class="n">sample_size</span><span class="o">=</span><span class="mi">500</span><span class="p">):</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">low</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">sample_size</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">+</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">x</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">sample_size</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="n">x</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="n">y</span><span class="p">})</span>

<span class="k">def</span> <span class="nf">sim_2</span><span class="p">(</span><span class="n">sample_size</span><span class="o">=</span><span class="mi">500</span><span class="p">):</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">low</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">sample_size</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">+</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">x</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">sample_size</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="n">x</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="n">y</span><span class="p">})</span>

<span class="k">def</span> <span class="nf">sim_3</span><span class="p">(</span><span class="n">sample_size</span><span class="o">=</span><span class="mi">500</span><span class="p">):</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">low</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">sample_size</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">+</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">x</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">sample_size</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="n">x</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="n">y</span><span class="p">})</span>

<span class="k">def</span> <span class="nf">plot_data_and_fit</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">title</span><span class="p">):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Data&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">)</span>
    <span class="c1"># Fitting model</span>
    <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">data</span><span class="p">[[</span><span class="s1">&#39;x&#39;</span><span class="p">]],</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">])</span>
    <span class="c1"># Plotting the fit</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkorange&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Fit&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    
    <span class="c1"># Residuals plot</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">data</span><span class="p">[[</span><span class="s1">&#39;x&#39;</span><span class="p">]]),</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">data</span><span class="p">[[</span><span class="s1">&#39;x&#39;</span><span class="p">]]),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkorange&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Residuals of </span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Fitted&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Residuals&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<section id="grafico-de-ajuste-frente-a-residuos">
<h2>Gráfico de ajuste frente a residuos<a class="headerlink" href="#grafico-de-ajuste-frente-a-residuos" title="Permalink to this heading">#</a></h2>
<p>Probablemente, nuestra herramienta más útil será un <strong>Plot ajustado frente a residuales</strong>. Será útil para comprobar los supuestos de <strong>linealidad</strong> y <strong>varianza constante</strong>.</p>
<p>Los datos generados a partir del Modelo 1 anterior no deberían mostrar ningún signo de violación de los supuestos, así que usaremos esto para ver cómo debería ser un buen gráfico de ajuste frente a residuos. Primero, simularemos las observaciones de este modelo.</p>
<p>A continuación, ajustamos el modelo y añadimos la línea ajustada a un gráfico de dispersión.</p>
<p>Posteriormente trazamos un gráfico de ajuste frente a los residuos. Tenga en cuenta que se trata de residuos en el eje <span class="math notranslate nohighlight">\(y\)</span> a pesar de la ordenación en el nombre. A veces verá que esto se denomina gráfico de residuos frente a ajustados, o residuos frente a predichos.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Simulating and plotting the data for each model</span>
<span class="n">lr</span> <span class="o">=</span> <span class="n">LinearRegression</span><span class="p">()</span>

<span class="n">sim_data_1</span> <span class="o">=</span> <span class="n">sim_1</span><span class="p">()</span>
<span class="n">plot_data_and_fit</span><span class="p">(</span><span class="n">lr</span><span class="p">,</span> <span class="n">sim_data_1</span><span class="p">,</span> <span class="s1">&#39;Data from Model 1&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>c:\ProgramData\Anaconda3\lib\site-packages\sklearn\base.py:450: UserWarning: X does not have valid feature names, but LinearRegression was fitted with feature names
  warnings.warn(
</pre></div>
</div>
<img alt="../_images/8b8998209e1052c0f533a58a24984b5dbe37aefeaea0341be0006756cb8e9677.png" src="../_images/8b8998209e1052c0f533a58a24984b5dbe37aefeaea0341be0006756cb8e9677.png" />
<img alt="../_images/25503f7fcc20360bddc5e7aa050e611985cfbfa79a8985116079f79b4e792867.png" src="../_images/25503f7fcc20360bddc5e7aa050e611985cfbfa79a8985116079f79b4e792867.png" />
</div>
</div>
<p>Debemos buscar dos cosas en este gráfico.</p>
<ul class="simple">
<li><p>En cualquier valor ajustado, la media de los residuos debe ser aproximadamente 0. Si es así, la hipótesis de <em>linealidad</em> es válida. Por esta razón, generalmente añadimos una línea horizontal en <span class="math notranslate nohighlight">\(y = 0\)</span> para enfatizar este punto.</p></li>
<li><p>En cada valor ajustado, la dispersión de los residuos debería ser aproximadamente la misma. Si éste es el caso, la hipótesis de <em>varianza constante</em> es válida.</p></li>
</ul>
<p>Aquí vemos que este es el caso para ambos.</p>
<p><strong>Para tener una mejor idea de cómo un gráfico de ajuste frente a residuos puede ser útil, simularemos a partir de modelos con supuestos violados.</strong></p>
<p>El modelo 2 es un ejemplo de varianza no constante. En este caso, la varianza es mayor para valores mayores de la variable predictora <span class="math notranslate nohighlight">\(x\)</span>.</p>
<p>En realidad, esto es bastante fácil de ver aquí añadiendo la línea ajustada a un gráfico de dispersión. Esto se debe a que sólo estamos realizando una regresión lineal simple. Con la regresión múltiple, un gráfico de ajuste frente a los residuos es una necesidad, ya que la adición de una regresión ajustada a un gráfico de dispersión no es exactamente posible.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sim_data_2</span> <span class="o">=</span> <span class="n">sim_2</span><span class="p">()</span>
<span class="n">plot_data_and_fit</span><span class="p">(</span><span class="n">lr</span><span class="p">,</span> <span class="n">sim_data_2</span><span class="p">,</span> <span class="s1">&#39;Data from Model 2&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>c:\ProgramData\Anaconda3\lib\site-packages\sklearn\base.py:450: UserWarning: X does not have valid feature names, but LinearRegression was fitted with feature names
  warnings.warn(
</pre></div>
</div>
<img alt="../_images/fb8af7e4c2721e69c9ed3b6a29d971c1642c8744b64e0acee7884ca5cfadd9bf.png" src="../_images/fb8af7e4c2721e69c9ed3b6a29d971c1642c8744b64e0acee7884ca5cfadd9bf.png" />
<img alt="../_images/c28a0e0f311ead14f1c62feb7574a1970693ba2ce435be5b80002ac8bad30a1a.png" src="../_images/c28a0e0f311ead14f1c62feb7574a1970693ba2ce435be5b80002ac8bad30a1a.png" />
</div>
</div>
<p>En el gráfico de ajuste frente a residuos, vemos dos cosas muy claras. Para cualquier valor ajustado, los residuos parecen centrarse aproximadamente en 0. ¡Esto es bueno! No se incumple el supuesto de linealidad. Sin embargo, también vemos claramente que para valores ajustados mayores, la dispersión de los residuos es mayor. Esto es malo. Aquí se viola la hipótesis de varianza constante.</p>
<p>Ahora demostraremos un modelo que no cumple el supuesto de linealidad. El modelo 3 es un ejemplo de un modelo en el que <span class="math notranslate nohighlight">\(Y\)</span> no es una combinación lineal de los predictores. En este caso el predictor es <span class="math notranslate nohighlight">\(x\)</span>, pero el modelo utiliza <span class="math notranslate nohighlight">\(x^2\)</span>. (Veremos más adelante que esto es algo que un modelo “lineal” puede tratar. La solución es sencilla: ¡haga que <span class="math notranslate nohighlight">\(x^2\)</span> sea un predictor!)</p>
<p>De nuevo, esto queda bastante claro en el diagrama de dispersión, pero de nuevo, no podríamos comprobar este diagrama para la regresión múltiple.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sim_data_3</span> <span class="o">=</span> <span class="n">sim_3</span><span class="p">()</span>
<span class="n">plot_data_and_fit</span><span class="p">(</span><span class="n">lr</span><span class="p">,</span> <span class="n">sim_data_3</span><span class="p">,</span> <span class="s1">&#39;Data from Model 3&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>c:\ProgramData\Anaconda3\lib\site-packages\sklearn\base.py:450: UserWarning: X does not have valid feature names, but LinearRegression was fitted with feature names
  warnings.warn(
</pre></div>
</div>
<img alt="../_images/bdbbaff74a3c1e18737513ed9b9442d84b6aed0bce0f30d69e559ff0d734d1ac.png" src="../_images/bdbbaff74a3c1e18737513ed9b9442d84b6aed0bce0f30d69e559ff0d734d1ac.png" />
<img alt="../_images/df2bae8bc96871101a7aab8404440cd901fb0dde4d9e1eb391ff4770e5197ffa.png" src="../_images/df2bae8bc96871101a7aab8404440cd901fb0dde4d9e1eb391ff4770e5197ffa.png" />
</div>
</div>
<p>Esta vez, en el gráfico de valores ajustados frente a residuos, la dispersión de los residuos es prácticamente la misma para cualquier valor ajustado. Sin embargo, ¡ni siquiera están centrados en cero! En los valores ajustados pequeños y grandes, el modelo subestima, mientras que en los valores ajustados medios, el modelo sobreestima. Se trata de errores sistemáticos, no de ruido aleatorio. Así que se cumple el supuesto de varianza constante, pero se viola el supuesto de linealidad. La forma de nuestro modelo es simplemente errónea. ¡Estamos tratando de ajustar una línea a una curva!</p>
</section>
<section id="prueba-de-breusch-pagan">
<h2>Prueba de Breusch-Pagan<a class="headerlink" href="#prueba-de-breusch-pagan" title="Permalink to this heading">#</a></h2>
<p>La varianza constante a menudo se llama <strong>homoscedasticidad</strong>. Por el contrario, la varianza no constante se llama <strong>heteroscedasticidad</strong>. Hemos visto cómo podemos utilizar un gráfico de ajuste frente a residuos para buscar estos atributos.</p>
<p>Aunque un gráfico de ajuste frente a residuos puede darnos una idea sobre la homocedasticidad, a veces preferimos una prueba más formal. Hay muchas pruebas para la varianza constante, pero aquí vamos a presentar una, el
<a href="https://en.wikipedia.org/wiki/Breusch%E2%80%93Pagan_test"
target="_blank"><strong>Breusch-Pagan Test</strong></a>. Los detalles exactos de la prueba se omitirán aquí, pero lo importante es que se puede considerar que la nula y la alternativa son,</p>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\(H_0\)</span>: Homoscedasticidad. Los errores tienen varianza constante respecto al modelo verdadero.</p></li>
<li><p><span class="math notranslate nohighlight">\(H_1\)</span>: Heteroscedasticidad. Los errores tienen varianza no constante sobre el modelo verdadero.</p></li>
</ul>
<p>¿No es conveniente? Una prueba que probará específicamente la <strong>suposición de varianza constante</strong>.</p>
<p>La prueba de Breusch-Pagan no se puede realizar por defecto en <code class="docutils literal notranslate"><span class="pre">Python</span></code>, sin embargo la función <code class="docutils literal notranslate"><span class="pre">bptest</span></code> en el paquete <code class="docutils literal notranslate"><span class="pre">lmtest</span></code> implementa la prueba.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">statsmodels.api</span> <span class="k">as</span> <span class="nn">sm</span>
<span class="kn">from</span> <span class="nn">statsmodels.stats.diagnostic</span> <span class="kn">import</span> <span class="n">het_breuschpagan</span>
</pre></div>
</div>
</div>
</div>
<p>Probémoslo con los tres modelos que hemos ajustado antes. Recordemos,</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">fit_1</span></code> no violó los supuestos,</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">fit_2</span></code> violó el supuesto de varianza constante, pero no la linealidad,</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">fit_3</span></code> violó la linealidad, pero no la varianza constante.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Fit model</span>
<span class="n">sim_data_1</span> <span class="o">=</span> <span class="n">sim_1</span><span class="p">()</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">add_constant</span><span class="p">(</span><span class="n">sim_data_1</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">])</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">OLS</span><span class="p">(</span><span class="n">sim_data_1</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">],</span> <span class="n">X</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>

<span class="n">bp_test</span> <span class="o">=</span> <span class="n">het_breuschpagan</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">resid</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">exog</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Breusch-Pagan test :</span><span class="se">\n</span><span class="s2">LM Statistic: </span><span class="si">{</span><span class="n">bp_test</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">LM-Test p-value: </span><span class="si">{</span><span class="n">bp_test</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">F-Statistic: </span><span class="si">{</span><span class="n">bp_test</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">F-Test p-value: </span><span class="si">{</span><span class="n">bp_test</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Breusch-Pagan test :
LM Statistic: 1.1472521637030941
LM-Test p-value: 0.2841251075614587
F-Statistic: 1.1452910302734016
F-Test p-value: 0.2850554830238379
</pre></div>
</div>
</div>
</div>
<p>Para <code class="docutils literal notranslate"><span class="pre">fit_1</span></code> vemos un valor p grande, por lo que no rechazamos la nulidad de homocedasticidad, que es lo que esperaríamos.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Fit model</span>
<span class="n">sim_data_2</span> <span class="o">=</span> <span class="n">sim_2</span><span class="p">()</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">add_constant</span><span class="p">(</span><span class="n">sim_data_2</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">])</span>
<span class="n">model2</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">OLS</span><span class="p">(</span><span class="n">sim_data_2</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">],</span> <span class="n">X</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>

<span class="n">bp_test2</span> <span class="o">=</span> <span class="n">het_breuschpagan</span><span class="p">(</span><span class="n">model2</span><span class="o">.</span><span class="n">resid</span><span class="p">,</span> <span class="n">model2</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">exog</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Breusch-Pagan test :</span><span class="se">\n</span><span class="s2">LM Statistic: </span><span class="si">{</span><span class="n">bp_test2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">LM-Test p-value: </span><span class="si">{</span><span class="n">bp_test2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">F-Statistic: </span><span class="si">{</span><span class="n">bp_test2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">F-Test p-value: </span><span class="si">{</span><span class="n">bp_test2</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Breusch-Pagan test :
LM Statistic: 115.62727940449763
LM-Test p-value: 5.735709707268932e-27
F-Statistic: 149.80871965686939
F-Test p-value: 2.67964265608043e-30
</pre></div>
</div>
</div>
</div>
<p>Para <code class="docutils literal notranslate"><span class="pre">fit_2</span></code> vemos un valor p pequeño, por lo que rechazamos la nulidad de homocedasticidad. Se incumple el supuesto de varianza constante. Esto coincide con nuestros hallazgos con un gráfico de ajuste frente a residuos.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Fit model</span>
<span class="n">sim_data_3</span> <span class="o">=</span> <span class="n">sim_3</span><span class="p">()</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">add_constant</span><span class="p">(</span><span class="n">sim_data_3</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">])</span>
<span class="n">model3</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">OLS</span><span class="p">(</span><span class="n">sim_data_3</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">],</span> <span class="n">X</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>

<span class="n">bp_test3</span> <span class="o">=</span> <span class="n">het_breuschpagan</span><span class="p">(</span><span class="n">model3</span><span class="o">.</span><span class="n">resid</span><span class="p">,</span> <span class="n">model3</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">exog</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Breusch-Pagan test :</span><span class="se">\n</span><span class="s2">LM Statistic: </span><span class="si">{</span><span class="n">bp_test3</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">LM-Test p-value: </span><span class="si">{</span><span class="n">bp_test3</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">F-Statistic: </span><span class="si">{</span><span class="n">bp_test3</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">F-Test p-value: </span><span class="si">{</span><span class="n">bp_test3</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Breusch-Pagan test :
LM Statistic: 0.5280474506670907
LM-Test p-value: 0.46742891042611134
F-Statistic: 0.5264912856267554
F-Test p-value: 0.46842657800532084
</pre></div>
</div>
</div>
</div>
<p>Por último, para <code class="docutils literal notranslate"><span class="pre">fit_3</span></code> volvemos a ver un valor p elevado, por lo que no rechazamos la nulidad de homocedasticidad, lo que coincide con nuestros resultados con un gráfico de ajuste frente a residuos.</p>
</section>
<section id="histogramas">
<h2>Histogramas<a class="headerlink" href="#histogramas" title="Permalink to this heading">#</a></h2>
<p>Disponemos de varias herramientas para evaluar el supuesto de normalidad. La más obvia sería hacer un histograma de los residuos. Si parece aproximadamente normal, entonces creeremos que los errores podrían ser realmente normales.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">statsmodels.formula.api</span> <span class="k">as</span> <span class="nn">smf</span>

<span class="k">def</span> <span class="nf">plot_residual_histogram</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">title</span><span class="p">):</span>
    <span class="n">residuals</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">resid</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">residuals</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkorange&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;dodgerblue&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Residuals&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Frequency&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>

<span class="c1"># Fitting models</span>
<span class="n">sim_data_1</span> <span class="o">=</span> <span class="n">sim_1</span><span class="p">()</span>
<span class="n">model_1</span> <span class="o">=</span> <span class="n">smf</span><span class="o">.</span><span class="n">ols</span><span class="p">(</span><span class="s1">&#39;y ~ x&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">sim_data_1</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>

<span class="n">sim_data_2</span> <span class="o">=</span> <span class="n">sim_2</span><span class="p">()</span>
<span class="n">model_2</span> <span class="o">=</span> <span class="n">smf</span><span class="o">.</span><span class="n">ols</span><span class="p">(</span><span class="s1">&#39;y ~ x&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">sim_data_2</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>

<span class="n">sim_data_3</span> <span class="o">=</span> <span class="n">sim_3</span><span class="p">()</span>
<span class="n">model_3</span> <span class="o">=</span> <span class="n">smf</span><span class="o">.</span><span class="n">ols</span><span class="p">(</span><span class="s1">&#39;y ~ x&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">sim_data_3</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>

<span class="c1"># Plotting</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">plot_residual_histogram</span><span class="p">(</span><span class="n">model_1</span><span class="p">,</span> <span class="s1">&#39;Histogram of Residuals, fit_1&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">plot_residual_histogram</span><span class="p">(</span><span class="n">model_2</span><span class="p">,</span> <span class="s1">&#39;Histogram of Residuals, fit_2&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">plot_residual_histogram</span><span class="p">(</span><span class="n">model_3</span><span class="p">,</span> <span class="s1">&#39;Histogram of Residuals, fit_3&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/b59e4b399ee5993ce03bb9e33282afaa73e4fcc0c39cddaa8a94e591d3af6ea4.png" src="../_images/b59e4b399ee5993ce03bb9e33282afaa73e4fcc0c39cddaa8a94e591d3af6ea4.png" />
</div>
</div>
<p>Arriba están los histogramas para cada uno de los tres modelos de regresión que hemos estado considerando. Observe que el primero, para <code class="docutils literal notranslate"><span class="pre">fit_1</span></code> parece muy normal. El tercero, para <code class="docutils literal notranslate"><span class="pre">fit_3</span></code>, parece muy poco normal. Sin embargo, <code class="docutils literal notranslate"><span class="pre">fit_2</span></code> no está tan claro. Tiene forma de campana, pero también presenta un pico muy agudo. Por este motivo, normalmente utilizaremos herramientas más potentes como <strong>los gráficos Q-Q</strong> y la prueba <strong>Shapiro-Wilk</strong> para evaluar la normalidad de los errores.</p>
</section>
<section id="graficos-q-q">
<h2>Gráficos Q-Q<a class="headerlink" href="#graficos-q-q" title="Permalink to this heading">#</a></h2>
<p>Otro método visual para evaluar la normalidad de los errores, que es más potente que un histograma, es un gráfico normal cuantil-cuantil, o <strong>gráfico Q-Q</strong> para abreviar.</p>
<p>En <code class="docutils literal notranslate"><span class="pre">Python</span></code> son muy fáciles de hacer. Simplemente importe la función <code class="docutils literal notranslate"><span class="pre">qqplot</span></code> del paquete <code class="docutils literal notranslate"><span class="pre">statsmodels.graphics.gofplots</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">statsmodels.api</span> <span class="k">as</span> <span class="nn">sm</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="c1"># Assuming model_1 is already fit from the previous code</span>
<span class="n">residuals_1</span> <span class="o">=</span> <span class="n">model_1</span><span class="o">.</span><span class="n">resid</span>

<span class="c1"># Q-Q plot</span>
<span class="n">sm</span><span class="o">.</span><span class="n">qqplot</span><span class="p">(</span><span class="n">residuals_1</span><span class="p">,</span> <span class="n">line</span><span class="o">=</span><span class="s1">&#39;q&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkgrey&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Normal Q-Q Plot, fit_1&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">get_lines</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_color</span><span class="p">(</span><span class="s1">&#39;dodgerblue&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">get_lines</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_linewidth</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>c:\ProgramData\Anaconda3\lib\site-packages\statsmodels\graphics\gofplots.py:1045: UserWarning: color is redundantly defined by the &#39;color&#39; keyword argument and the fmt string &quot;b&quot; (-&gt; color=(0.2980392156862745, 0.4470588235294118, 0.6901960784313725, 1)). The keyword argument will take precedence.
  ax.plot(x, y, fmt, **plot_style)
</pre></div>
</div>
<img alt="../_images/2b561b18c12b9f479ab2b89eb1a6ea84866c251ee17bdef92913b21d072895ed.png" src="../_images/2b561b18c12b9f479ab2b89eb1a6ea84866c251ee17bdef92913b21d072895ed.png" />
</div>
</div>
<p>En resumen, si los puntos del gráfico no siguen de cerca una línea recta, esto sugeriría que los datos no proceden de una distribución normal.</p>
<p>Los cálculos necesarios para crear el gráfico varían en función de la implementación, pero esencialmente el eje <span class="math notranslate nohighlight">\(y\)</span> son los datos ordenados (observados, o cuantiles de muestra), y el eje <span class="math notranslate nohighlight">\(x\)</span> son los valores que esperaríamos si los datos procedieran de una distribución normal (cuantiles teóricos).</p>
<p>Además, para tener una mejor idea de cómo funcionan los gráficos Q-Q, aquí hay una función rápida que crea un gráfico Q-Q:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">norm</span><span class="p">,</span> <span class="n">probplot</span>

<span class="k">def</span> <span class="nf">qq_plot</span><span class="p">(</span><span class="n">residuals</span><span class="p">):</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">residuals</span><span class="p">)</span>
    <span class="n">normal_quantiles</span> <span class="o">=</span> <span class="n">norm</span><span class="o">.</span><span class="n">ppf</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">/</span> <span class="n">n</span><span class="p">)</span>
    <span class="n">sorted_residuals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">residuals</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">normal_quantiles</span><span class="p">,</span> <span class="n">sorted_residuals</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkgrey&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Theoretical Quantiles&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Sample Quantiles&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Normal Q-Q Plot&#39;</span><span class="p">)</span>
    
    <span class="c1"># Calculate line through the first and third quartiles</span>
    <span class="n">slope</span><span class="p">,</span> <span class="n">intercept</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span>
        <span class="n">norm</span><span class="o">.</span><span class="n">ppf</span><span class="p">([</span><span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.75</span><span class="p">]),</span> 
        <span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">residuals</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.75</span><span class="p">]),</span> 
        <span class="n">deg</span><span class="o">=</span><span class="mi">1</span>
    <span class="p">)</span>
    
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">normal_quantiles</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">normal_quantiles</span><span class="p">),</span> <span class="mi">100</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">intercept</span> <span class="o">+</span> <span class="n">slope</span> <span class="o">*</span> <span class="n">x</span><span class="p">,</span> <span class="s1">&#39;dodgerblue&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>A continuación, podemos comprobar que es esencialmente equivalente a utilizar <code class="docutils literal notranslate"><span class="pre">probplot()</span></code> y <code class="docutils literal notranslate"><span class="pre">qq_plot()</span></code> en <code class="docutils literal notranslate"><span class="pre">Python</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">420</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">probplot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="n">plt</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">get_lines</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_markerfacecolor</span><span class="p">(</span><span class="s1">&#39;darkgrey&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">get_lines</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_color</span><span class="p">(</span><span class="s1">&#39;dodgerblue&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">get_lines</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_linewidth</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">qq_plot</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/e2ac06f90b69cc7a76a3e3eb0bab6513f8afe7f3e1a125deb9ee41766242317c.png" src="../_images/e2ac06f90b69cc7a76a3e3eb0bab6513f8afe7f3e1a125deb9ee41766242317c.png" />
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;Figure size 640x480 with 0 Axes&gt;
</pre></div>
</div>
</div>
</div>
<p>Para hacernos una mejor idea de lo que significa “acercarse a la línea”, realizamos varias simulaciones y creamos gráficos Q-Q.</p>
<p>Primero simulamos datos de una distribución normal con diferentes tamaños de muestra y cada vez creamos un gráfico Q-Q.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">420</span><span class="p">)</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">18</span><span class="p">))</span>  <span class="c1"># Adjust the first value for width, and the second for height of the overall figure</span>

<span class="c1"># Creating Axes objects (i.e., subplots) with consistent sizes</span>
<span class="n">ax1</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># 3 rows, 1 column, first plot</span>
<span class="n">qq_plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">10</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>  <span class="c1"># Setting x-axis limits</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>  <span class="c1"># Setting y-axis limits</span>
<span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>  <span class="c1"># Clear the figure created inside qq_plot</span>

<span class="n">ax2</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># 3 rows, 1 column, second plot</span>
<span class="n">qq_plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">25</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>  <span class="c1"># Setting x-axis limits</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>  <span class="c1"># Setting y-axis limits</span>
<span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>  <span class="c1"># Clear the figure created inside qq_plot</span>

<span class="n">ax3</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>  <span class="c1"># 3 rows, 1 column, third plot</span>
<span class="n">qq_plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">100</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>  <span class="c1"># Setting x-axis limits</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>  <span class="c1"># Setting y-axis limits</span>
<span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>  <span class="c1"># Clear the figure created inside qq_plot</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>  <span class="c1"># Adjust layout to prevent overlapping</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/5b81e8d22d4a0d5513c62a23c7749f43555f3f803aab4261f7b409667eb10298.png" src="../_images/5b81e8d22d4a0d5513c62a23c7749f43555f3f803aab4261f7b409667eb10298.png" />
<img alt="../_images/bf6679766c1ce3203557bf548f9426602c03edae1e92a83d00f92d387b88ed9b.png" src="../_images/bf6679766c1ce3203557bf548f9426602c03edae1e92a83d00f92d387b88ed9b.png" />
<img alt="../_images/f6320874c2fbb3c0047f60c3662f78005f54e8f4b8bf207208d5e3bcfae9176a.png" src="../_images/f6320874c2fbb3c0047f60c3662f78005f54e8f4b8bf207208d5e3bcfae9176a.png" />
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;Figure size 640x480 with 0 Axes&gt;
</pre></div>
</div>
</div>
</div>
<p>Dado que estos datos <strong>son</strong> muestras de una distribución normal, todos ellos son, por definición, buenos gráficos Q-Q. Los puntos están “cerca de la línea” y concluiríamos que estos datos podrían haber sido muestreados a partir de una distribución normal. Observe que en el primer gráfico, un punto está <em>algo</em> lejos de la línea, pero un solo punto, en combinación con el pequeño tamaño de la muestra, no es suficiente para preocuparnos. Vemos que con el gran tamaño de la muestra, todos los puntos están bastante cerca de la línea.</p>
<p>A continuación, simulamos los datos de una distribución <span class="math notranslate nohighlight">\(t\)</span> con pocos grados de libertad, para diferentes tamaños de muestra.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">t</span>

<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">420</span><span class="p">)</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">18</span><span class="p">))</span>  <span class="c1"># Adjust the first value for width, and the second for height of the overall figure</span>

<span class="c1"># Creating Axes objects (i.e., subplots) with consistent sizes</span>
<span class="n">ax1</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># 3 rows, 1 column, first plot</span>
<span class="n">qq_plot</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">10</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>  <span class="c1"># Setting x-axis limits</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>  <span class="c1"># Setting y-axis limits</span>
<span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>  <span class="c1"># Clear the figure created inside qq_plot</span>

<span class="n">ax2</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># 3 rows, 1 column, second plot</span>
<span class="n">qq_plot</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">25</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>  <span class="c1"># Setting x-axis limits</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>  <span class="c1"># Setting y-axis limits</span>
<span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>  <span class="c1"># Clear the figure created inside qq_plot</span>

<span class="n">ax3</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>  <span class="c1"># 3 rows, 1 column, third plot</span>
<span class="n">qq_plot</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">100</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>  <span class="c1"># Setting x-axis limits</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>  <span class="c1"># Setting y-axis limits</span>
<span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>  <span class="c1"># Clear the figure created inside qq_plot</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>  <span class="c1"># Adjust layout to prevent overlapping</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/5994ee7ccb8573b6df8ef7003c0c6824117620162da6b6af93d062a1eb71245c.png" src="../_images/5994ee7ccb8573b6df8ef7003c0c6824117620162da6b6af93d062a1eb71245c.png" />
<img alt="../_images/a640e75f1223bcd10a96afc067d571626f11b3727ab6a3867a86184bd6964a26.png" src="../_images/a640e75f1223bcd10a96afc067d571626f11b3727ab6a3867a86184bd6964a26.png" />
<img alt="../_images/6baa055a3a46a9edf05cab5751dc07d195bb09e67565f730d11310563352a2fc.png" src="../_images/6baa055a3a46a9edf05cab5751dc07d195bb09e67565f730d11310563352a2fc.png" />
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;Figure size 640x480 with 0 Axes&gt;
</pre></div>
</div>
</div>
</div>
<p>Recordemos que a medida que aumentan los grados de libertad de una distribución <span class="math notranslate nohighlight">\(t\)</span>, la distribución se parece cada vez más a una normal. Aquí, utilizando 4 grados de libertad, tenemos una distribución que es algo normal, es simétrica y aproximadamente en forma de campana, sin embargo tiene “colas gordas”. Esto se presenta claramente en el tercer panel. Aunque muchos de los puntos están cerca de la línea, en los bordes hay grandes discrepancias. Esto indica que los valores son demasiado pequeños (negativos) o demasiado grandes (positivos) en comparación con lo que cabría esperar de una distribución normal. Por tanto, para el tamaño de muestra de <code class="docutils literal notranslate"><span class="pre">100</span></code>, llegaríamos a la conclusión de que se incumple el supuesto de normalidad. (Si se tratara de residuos de un modelo.) Para tamaños de muestra de <code class="docutils literal notranslate"><span class="pre">10</span></code> y <code class="docutils literal notranslate"><span class="pre">25</span></code> podríamos sospechar, pero no estar totalmente seguros. Leer gráficos Q-Q es un arte, no una ciencia.</p>
<p>A continuación, simulamos los datos a partir de una distribución exponencial.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">420</span><span class="p">)</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">18</span><span class="p">))</span>  <span class="c1"># Adjust the first value for width, and the second for height of the overall figure</span>

<span class="c1"># Creating Axes objects (i.e., subplots) with consistent sizes</span>
<span class="n">ax1</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># 3 rows, 1 column, first plot</span>
<span class="n">qq_plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">exponential</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">10</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>  <span class="c1"># Setting x-axis limits</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>  <span class="c1"># Setting y-axis limits</span>
<span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>  <span class="c1"># Clear the figure created inside qq_plot</span>

<span class="n">ax2</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># 3 rows, 1 column, second plot</span>
<span class="n">qq_plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">exponential</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">25</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>  <span class="c1"># Setting x-axis limits</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>  <span class="c1"># Setting y-axis limits</span>
<span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>  <span class="c1"># Clear the figure created inside qq_plot</span>

<span class="n">ax3</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>  <span class="c1"># 3 rows, 1 column, third plot</span>
<span class="n">qq_plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">exponential</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">100</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>  <span class="c1"># Setting x-axis limits</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>  <span class="c1"># Setting y-axis limits</span>
<span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>  <span class="c1"># Clear the figure created inside qq_plot</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>  <span class="c1"># Adjust layout to prevent overlapping</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/3443d0df6582d69cccde683493a3ffa338719166836a82f5bb258e1cecab19fe.png" src="../_images/3443d0df6582d69cccde683493a3ffa338719166836a82f5bb258e1cecab19fe.png" />
<img alt="../_images/88b0d89b70e79b8d83818cd80dc06388cd025ea757d193277fa413989a290018.png" src="../_images/88b0d89b70e79b8d83818cd80dc06388cd025ea757d193277fa413989a290018.png" />
<img alt="../_images/2f2d4b4468293363ed66855aca86e3e508ca49e586e0edb92fc23e89d63c5c22.png" src="../_images/2f2d4b4468293363ed66855aca86e3e508ca49e586e0edb92fc23e89d63c5c22.png" />
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;Figure size 640x480 with 0 Axes&gt;
</pre></div>
</div>
</div>
</div>
<p>Esta es una distribución que no se parece mucho a una normal, por lo que en los tres casos, vemos puntos que están lejos de las líneas, por lo que podríamos pensar que se viola el supuesto de normalidad.</p>
<p>Para comprender mejor qué gráficos Q-Q son “buenos”, repita las simulaciones anteriores varias veces (sin establecer la semilla) y preste atención a las diferencias entre los que se simulan a partir de la normal y los que no. Considere también diferentes tamaños de muestra y parámetros de distribución.</p>
<p>Volviendo a nuestras tres regresiones, recuerde,</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">fit_1</span></code> no violaba los supuestos,</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">fit_2</span></code> violó el supuesto de varianza constante, pero no la linealidad,</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">fit_3</span></code> violó la linealidad, pero no la varianza constante.</p></li>
</ul>
<p>Ahora vamos a crear un gráfico Q-Q para cada uno para evaluar la normalidad de los errores.</p>
<p>Para <code class="docutils literal notranslate"><span class="pre">fit_1</span></code>, tenemos un gráfico Q-Q casi perfecto. Creemos que los errores siguen una distribución normal.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># For residuals of previously fit models</span>
<span class="n">qq_plot</span><span class="p">(</span><span class="n">model_1</span><span class="o">.</span><span class="n">resid</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/d0eff1229922ad2816fbe60e09cf29a14f45fae7bd5edb7eff1fc19bb90d058d.png" src="../_images/d0eff1229922ad2816fbe60e09cf29a14f45fae7bd5edb7eff1fc19bb90d058d.png" />
</div>
</div>
<p>Para <code class="docutils literal notranslate"><span class="pre">fit_2</span></code>, tenemos un gráfico Q-Q sospechoso. Probablemente <strong>no</strong> creamos que los errores siguen una distribución normal.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">qq_plot</span><span class="p">(</span><span class="n">model_2</span><span class="o">.</span><span class="n">resid</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/ce9f4bbcd29c47ea93ed677d68ed681acf548ed855bbfdefaf36b0feebff52ff.png" src="../_images/ce9f4bbcd29c47ea93ed677d68ed681acf548ed855bbfdefaf36b0feebff52ff.png" />
</div>
</div>
<p>Por último, para <code class="docutils literal notranslate"><span class="pre">fit_3</span></code>, volvemos a tener un gráfico Q-Q sospechoso. Probablemente <strong>no</strong> creamos que los errores siguen una distribución normal.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">qq_plot</span><span class="p">(</span><span class="n">model_3</span><span class="o">.</span><span class="n">resid</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/227ce236b8d28d7f45650c9dab3e29800c9bb0adda8ff80b4469221f8c6112cc.png" src="../_images/227ce236b8d28d7f45650c9dab3e29800c9bb0adda8ff80b4469221f8c6112cc.png" />
</div>
</div>
</section>
<section id="prueba-de-shapiro-wilk">
<h2>Prueba de Shapiro-Wilk<a class="headerlink" href="#prueba-de-shapiro-wilk" title="Permalink to this heading">#</a></h2>
<p>Los histogramas y los gráficos Q-Q ofrecen una buena representación visual de la distribución de los residuos. distribución de los residuos, sin embargo si estamos interesados en pruebas formales, hay varias opciones disponibles. Una prueba comúnmente utilizada es la <strong>Shapiro-Wilk</strong>, que se implementa en <code class="docutils literal notranslate"><span class="pre">Python</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">scipy.stats</span> <span class="k">as</span> <span class="nn">stats</span>

<span class="c1"># Set seed for reproducibility</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>

<span class="c1"># Perform Shapiro-Wilk test for normality on different datasets</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Shapiro-Wilk Test on standard normal distribution:&quot;</span><span class="p">,</span> <span class="n">stats</span><span class="o">.</span><span class="n">shapiro</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">25</span><span class="p">)))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Shapiro-Wilk Test on exponential distribution:&quot;</span><span class="p">,</span> <span class="n">stats</span><span class="o">.</span><span class="n">shapiro</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">exponential</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">25</span><span class="p">)))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Shapiro-Wilk Test on standard normal distribution: ShapiroResult(statistic=0.9696140885353088, pvalue=0.6352972388267517)
Shapiro-Wilk Test on exponential distribution: ShapiroResult(statistic=0.8586251139640808, pvalue=0.0025791579391807318)
</pre></div>
</div>
</div>
</div>
<p>Esto nos da el valor de la estadística de prueba y su valor p. La hipótesis nula supone que los datos se muestrearon a partir de una distribución normal, por lo que un valor p pequeño indica que creemos que sólo hay una pequeña probabilidad de que los datos se hayan muestreado a partir de una distribución normal.</p>
<p>Para más detalles, véase:
<a href="https://en.wikipedia.org/wiki/Shapiro-Wilk_test"
target="_blank">Wikipedia: Shapiro–Wilk test.</a></p>
<p>En los ejemplos anteriores, vemos que fallamos en rechazar para los datos muestreados de normal, y rechazamos en los datos no normales, para cualquier <span class="math notranslate nohighlight">\(\alpha\)</span> razonable.</p>
<p>Volviendo de nuevo a <code class="docutils literal notranslate"><span class="pre">fit_1</span></code>, <code class="docutils literal notranslate"><span class="pre">fit_2</span></code>, y <code class="docutils literal notranslate"><span class="pre">fit_3</span></code>, vemos que el resultado de ejecutar <code class="docutils literal notranslate"><span class="pre">shapiro.test()</span></code> en los residuos de cada uno, devuelve un resultado para cada uno que coincide con las decisiones basadas en los gráficos Q-Q.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">scipy.stats</span> <span class="k">as</span> <span class="nn">stats</span>


<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Shapiro-Wilk Test on residuals of fit_1:&quot;</span><span class="p">,</span> <span class="n">stats</span><span class="o">.</span><span class="n">shapiro</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">resid</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Shapiro-Wilk Test on residuals of fit_2:&quot;</span><span class="p">,</span> <span class="n">stats</span><span class="o">.</span><span class="n">shapiro</span><span class="p">(</span><span class="n">model2</span><span class="o">.</span><span class="n">resid</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Shapiro-Wilk Test on residuals of fit_3:&quot;</span><span class="p">,</span> <span class="n">stats</span><span class="o">.</span><span class="n">shapiro</span><span class="p">(</span><span class="n">model3</span><span class="o">.</span><span class="n">resid</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Shapiro-Wilk Test on residuals of fit_1: ShapiroResult(statistic=0.9968410134315491, pvalue=0.441923052072525)
Shapiro-Wilk Test on residuals of fit_2: ShapiroResult(statistic=0.9438427090644836, pvalue=8.081862002545792e-13)
Shapiro-Wilk Test on residuals of fit_3: ShapiroResult(statistic=0.9722673296928406, pvalue=3.9785284400295495e-08)
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="observaciones-inusuales">
<h1>Observaciones inusuales<a class="headerlink" href="#observaciones-inusuales" title="Permalink to this heading">#</a></h1>
<p>Además de comprobar los supuestos de la regresión, también buscamos cualquier “observación inusual” en los datos. A menudo, un pequeño número de puntos de datos puede tener una influencia extremadamente grande en una regresión, a veces tanto que los supuestos de regresión se violan como resultado de estos puntos.</p>
<p>Los tres gráficos siguientes se inspiran en un ejemplo de <a href="http://www.maths.bath.ac.uk/~jjf23/LMR/" target="_blank">Modelos lineales con R</a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">statsmodels.api</span> <span class="k">as</span> <span class="nn">sm</span>

<span class="c1"># Set seed for reproducibility</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>

<span class="c1"># Create the initial dataset</span>
<span class="n">ex_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">11</span><span class="p">),</span>
                        <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">10</span><span class="p">)})</span>

<span class="c1"># Fit the initial linear model</span>
<span class="n">ex_model</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">OLS</span><span class="p">(</span><span class="n">ex_data</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">],</span> <span class="n">sm</span><span class="o">.</span><span class="n">add_constant</span><span class="p">(</span><span class="n">ex_data</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]))</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>

<span class="c1"># Define points to add</span>
<span class="n">point_1</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">5.4</span><span class="p">],</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">11</span><span class="p">]})</span>
<span class="n">point_2</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">18</span><span class="p">],</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="p">[</span><span class="o">-</span><span class="mf">5.7</span><span class="p">]})</span>
<span class="n">point_3</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">14</span><span class="p">],</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">5.1</span><span class="p">]})</span>

<span class="c1"># Initialize subplots</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>

<span class="c1"># Low Leverage, Large Residual, Small Influence</span>
<span class="n">ex_data_1</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">ex_data</span><span class="p">,</span> <span class="n">point_1</span><span class="p">],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">model_1</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">OLS</span><span class="p">(</span><span class="n">ex_data_1</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">],</span> <span class="n">sm</span><span class="o">.</span><span class="n">add_constant</span><span class="p">(</span><span class="n">ex_data_1</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]))</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">ex_data</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span> <span class="n">ex_data</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Original Data&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">point_1</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span> <span class="n">point_1</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">160</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Added Point&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ex_data_1</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span> <span class="n">ex_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">sm</span><span class="o">.</span><span class="n">add_constant</span><span class="p">(</span><span class="n">ex_data_1</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">])),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;old Model&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ex_data_1</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span> <span class="n">model_1</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">sm</span><span class="o">.</span><span class="n">add_constant</span><span class="p">(</span><span class="n">ex_data_1</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">])),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkorange&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;New Model&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Low Leverage, Large Residual, Small Influence&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">)</span>

<span class="c1"># High Leverage, Small Residual, Small Influence</span>
<span class="n">ex_data_2</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">ex_data</span><span class="p">,</span> <span class="n">point_2</span><span class="p">],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">model_2</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">OLS</span><span class="p">(</span><span class="n">ex_data_2</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">],</span> <span class="n">sm</span><span class="o">.</span><span class="n">add_constant</span><span class="p">(</span><span class="n">ex_data_2</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]))</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">ex_data_2</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span> <span class="n">ex_data_2</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Original Data&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">point_2</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span> <span class="n">point_2</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">160</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Added Point&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ex_data_2</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span> <span class="n">ex_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">sm</span><span class="o">.</span><span class="n">add_constant</span><span class="p">(</span><span class="n">ex_data_2</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">])),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;old Model&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ex_data_2</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span> <span class="n">model_2</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">sm</span><span class="o">.</span><span class="n">add_constant</span><span class="p">(</span><span class="n">ex_data_2</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">])),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkorange&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;New Model&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;High Leverage, Small Residual, Small Influence&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">)</span>

<span class="c1"># High Leverage, Large Residual, Large Influence</span>
<span class="n">ex_data_3</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">ex_data</span><span class="p">,</span> <span class="n">point_3</span><span class="p">],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">model_3</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">OLS</span><span class="p">(</span><span class="n">ex_data_3</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">],</span> <span class="n">sm</span><span class="o">.</span><span class="n">add_constant</span><span class="p">(</span><span class="n">ex_data_3</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]))</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">ex_data_3</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span> <span class="n">ex_data_3</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Original Data&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">point_3</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span> <span class="n">point_3</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">160</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Added Point&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ex_data_3</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span> <span class="n">ex_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">sm</span><span class="o">.</span><span class="n">add_constant</span><span class="p">(</span><span class="n">ex_data_3</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">])),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;old Model&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ex_data_3</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span> <span class="n">model_3</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">sm</span><span class="o">.</span><span class="n">add_constant</span><span class="p">(</span><span class="n">ex_data_3</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">])),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkorange&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;New Model&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;High Leverage, Large Residual, Large Influence&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">)</span>

<span class="c1"># Add legends</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;lower left&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;lower left&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;lower left&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/dae10f4485888ff7d0161188ac1d372d900ae6a20f41270ab252974ed3db1c2d.png" src="../_images/dae10f4485888ff7d0161188ac1d372d900ae6a20f41270ab252974ed3db1c2d.png" />
</div>
</div>
<p>La línea continua azul de cada gráfico es un ajuste de regresión a los 10 puntos de datos originales almacenados en ex_data. La línea naranja discontinua de cada gráfico es el resultado de añadir un único punto a los datos originales de ex_data. Este punto adicional se indica con un círculo.</p>
<p>La pendiente de la regresión para los diez puntos originales, la línea azul continua, viene dada por:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ex_model</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-1.0069003716838811
</pre></div>
</div>
</div>
</div>
<p>El punto añadido en el primer gráfico tiene un efecto <em>pequeño</em> en la pendiente, que pasa a ser:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model_1</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-1.0123556921456858
</pre></div>
</div>
</div>
</div>
<p>Diremos que este punto tiene poca influencia, es un valor atípico debido a su gran residuo, pero tiene poca influencia.</p>
<p>El punto añadido en el segundo gráfico también tiene un <em>pequeño</em> efecto en la pendiente, que es:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model_2</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-0.9594209418078811
</pre></div>
</div>
</div>
</div>
<p>Diremos que este punto tiene un apalancamiento alto, no es un valor atípico debido a su pequeño residuo y tiene una influencia muy pequeña.</p>
<p>Por último, el punto añadido en el tercer gráfico tiene un efecto <em>grande</em> en la pendiente, que ahora es:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model_3</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-0.6048142833113597
</pre></div>
</div>
</div>
</div>
<p>Este punto añadido es influyente. Tiene un apalancamiento elevado y es un valor atípico debido a su gran residuo.</p>
<p>Ahora hemos mencionado tres nuevos conceptos: apalancamiento, valores atípicos y puntos influyentes, cada uno de los cuales trataremos en detalle.</p>
<section id="apalancamiento">
<h2>Apalancamiento<a class="headerlink" href="#apalancamiento" title="Permalink to this heading">#</a></h2>
<p>Un punto de datos con alto <strong>apalancamiento</strong>, es un punto de datos que <em>podría</em> tener una gran influencia al ajustar el modelo.</p>
<p>Recordemos que,</p>
<div class="math notranslate nohighlight">
\[\hat{\beta} = \left(X^\top X \right)^{-1} X^\top y.\]</div>
<p>Así,</p>
<div class="math notranslate nohighlight">
\[ \hat{y} = X \hat{\beta}   = X \left(X^\top X \right)^{-1} X^\top y\]</div>
<p>Ahora definimos,</p>
<div class="math notranslate nohighlight">
\[H = X \left(X^\top X\right)^{-1} X^\top\]</div>
<p>que denominaremos <em>matriz sombrero</em>. La matriz sombrero se utiliza para proyectar sobre el subespacio abarcado por las columnas de <span class="math notranslate nohighlight">\(X\)</span>. También se conoce simplemente como matriz de proyección.</p>
<p>La matriz sombrero es una matriz que toma los valores originales de <span class="math notranslate nohighlight">\(y\)</span> ¡y les añade un sombrero!</p>
<div class="math notranslate nohighlight">
\[\hat{y} = H y\]</div>
<p>Los elementos diagonales de esta matriz se denominan <strong>apalancamientos</strong>.</p>
<div class="math notranslate nohighlight">
\[H_{ii} = h_i,\]</div>
<p>donde <span class="math notranslate nohighlight">\(h_i\)</span> es el apalancamiento de la observación <span class="math notranslate nohighlight">\(i\)</span>ésima.</p>
<p>Los valores grandes de <span class="math notranslate nohighlight">\(h_i\)</span> indican valores extremos en <span class="math notranslate nohighlight">\(X\)</span>, que pueden influir en la regresión. Tenga en cuenta que los apalancamientos sólo dependen de <span class="math notranslate nohighlight">\(X\)</span>.</p>
<p>Aquí, <span class="math notranslate nohighlight">\(p\)</span>, el número de <span class="math notranslate nohighlight">\(\beta\)</span>s, es también la traza (y el rango) de la matriz sombrero.</p>
<div class="math notranslate nohighlight">
\[ \sum_{i = 1}^n h_i = p \]</div>
<p>¿Cuál es el valor de <span class="math notranslate nohighlight">\(h_i\)</span> que se consideraría grande? No hay una respuesta exacta a esta pregunta. Una heurística común sería comparar cada apalancamiento con dos veces el apalancamiento medio. Un apalancamiento superior a este valor se considera una observación a tener en cuenta. Es decir, si</p>
<div class="math notranslate nohighlight">
\[ h_i &gt; 2 \bar{h} \]</div>
<p>decimos que la observación <span class="math notranslate nohighlight">\(i\)</span> tiene un gran apalancamiento. Aquí,</p>
<div class="math notranslate nohighlight">
\[ \bar{h} = \frac{\sum_{i = 1}^n h_i}{n} = \frac{p}{n}.\]</div>
<p>Para la regresión lineal simple, el apalancamiento de cada punto viene dado por</p>
<div class="math notranslate nohighlight">
\[h_i = \frac{1}{n} + \frac{(x_i - \bar{x})^2}{S_{xx}}.\]</div>
<p>Esta expresión debería resultarte familiar. (Sugiere que los grandes apalancamientos se producen cuando los valores de <span class="math notranslate nohighlight">\(x\)</span> están lejos de su media. Recordemos que la regresión pasa por el punto <span class="math notranslate nohighlight">\((\bar{x},\bar{y})\)</span>.</p>
<p>Hay varias maneras de encontrar apalancamientos en <code class="docutils literal notranslate"><span class="pre">Python</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">statsmodels.api</span> <span class="k">as</span> <span class="nn">sm</span>
<span class="kn">import</span> <span class="nn">statsmodels.formula.api</span> <span class="k">as</span> <span class="nn">smf</span>

<span class="c1"># Create the lev_ex DataFrame</span>
<span class="n">lev_ex</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
    <span class="s1">&#39;x1&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">8</span><span class="p">],</span>
    <span class="s1">&#39;x2&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
    <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">11</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">8</span><span class="p">]</span>
<span class="p">})</span>

<span class="c1"># Plot x2 vs. x1</span>
<span class="n">lev_ex</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;x1&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;x2&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">40</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">80</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;x1&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;x2&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0, 0.5, &#39;x2&#39;)
</pre></div>
</div>
<img alt="../_images/754100ffbf15c010f0e1fd901f10ba5f848ccf9f66dbee01a2bafa903d0649a7.png" src="../_images/754100ffbf15c010f0e1fd901f10ba5f848ccf9f66dbee01a2bafa903d0649a7.png" />
</div>
</div>
<p>Aquí hemos creado algunos datos multivariantes. Observa que hemos trazado los valores <span class="math notranslate nohighlight">\(x\)</span>, no los valores <span class="math notranslate nohighlight">\(y\)</span>. El punto rojo es <span class="math notranslate nohighlight">\((7, 3)\)</span>, que es la media de <code class="docutils literal notranslate"><span class="pre">x1</span></code> y la media de <code class="docutils literal notranslate"><span class="pre">x2</span></code> respectivamente.</p>
<p>Podríamos calcular los apalancamientos utilizando las expresiones definidas anteriormente. Primero creamos la matriz <span class="math notranslate nohighlight">\(X\)</span>, luego calculamos <span class="math notranslate nohighlight">\(H\)</span> como se ha definido, y extraemos los elementos diagonales.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create design matrix X</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">add_constant</span><span class="p">(</span><span class="n">lev_ex</span><span class="p">[[</span><span class="s1">&#39;x1&#39;</span><span class="p">,</span> <span class="s1">&#39;x2&#39;</span><span class="p">]])</span>

<span class="c1"># Calculate the hat matrix H</span>
<span class="n">H</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">X</span><span class="p">))),</span> <span class="n">X</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>

<span class="c1"># Diagonal of the hat matrix</span>
<span class="n">diag_H</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">H</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">diag_H</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[0.6    0.375  0.2875 0.125  0.4    0.2125 0.5875 0.4125]
</pre></div>
</div>
</div>
</div>
<p>Tenga en cuenta aquí, tenemos dos predictores, por lo que la regresión tendría 3 <span class="math notranslate nohighlight">\(\beta\)</span> parámetros, por lo que la suma de los elementos diagonales es 3.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Sum of diagonal elements</span>
<span class="n">sum_diag_H</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">diag_H</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">sum_diag_H</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>3.000000000000001
</pre></div>
</div>
</div>
</div>
<p>Alternativamente, el método que utilizaremos más a menudo, es simplemente ajustar una regresión, y luego utilizar la función <code class="docutils literal notranslate"><span class="pre">hatvalues()</span></code>, que devuelve los apalancamientos.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Fit a linear model</span>
<span class="n">lev_fit</span> <span class="o">=</span> <span class="n">smf</span><span class="o">.</span><span class="n">ols</span><span class="p">(</span><span class="n">formula</span><span class="o">=</span><span class="s1">&#39;y ~ x1 + x2&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">lev_ex</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Hat values</span>
<span class="n">hat_values</span> <span class="o">=</span> <span class="n">lev_fit</span><span class="o">.</span><span class="n">get_influence</span><span class="p">()</span><span class="o">.</span><span class="n">hat_matrix_diag</span>
<span class="nb">print</span><span class="p">(</span><span class="n">hat_values</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[0.6    0.375  0.2875 0.125  0.4    0.2125 0.5875 0.4125]
</pre></div>
</div>
</div>
</div>
<p>De nuevo, observe que aquí hemos “utilizado” los valores <span class="math notranslate nohighlight">\(y\)</span> para ajustar la regresión, pero <code class="docutils literal notranslate"><span class="pre">Python</span></code> sigue ignorándolos al calcular los apalancamientos, ya que los apalancamientos sólo dependen de los valores <span class="math notranslate nohighlight">\(x\)</span>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Coefficients of the linear model</span>
<span class="n">coefficients</span> <span class="o">=</span> <span class="n">lev_fit</span><span class="o">.</span><span class="n">params</span>
<span class="nb">print</span><span class="p">(</span><span class="n">coefficients</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Intercept    3.7
x1          -0.7
x2           4.4
dtype: float64
</pre></div>
</div>
</div>
</div>
<p>Veamos qué ocurre con estos coeficientes cuando modificamos el valor <code class="docutils literal notranslate"><span class="pre">y</span></code> del punto con mayor palanca.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Index of the observation with the maximum hat value</span>
<span class="n">max_hat_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">hat_values</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">max_hat_index</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Observation with the maximum hat value</span>
<span class="n">obs_max_hat</span> <span class="o">=</span> <span class="n">lev_ex</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">max_hat_index</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="n">obs_max_hat</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>x1     0
x2     1
y     11
Name: 0, dtype: int64
</pre></div>
</div>
</div>
</div>
<p>Vemos que el valor <code class="docutils literal notranslate"><span class="pre">y</span></code> original es 11. Vamos a crear una copia de los datos, y modificar este punto para tener un valor <code class="docutils literal notranslate"><span class="pre">y</span></code> de <code class="docutils literal notranslate"><span class="pre">20</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create a modified copy of lev_ex with y[1] = 20</span>
<span class="n">lev_ex_1</span> <span class="o">=</span> <span class="n">lev_ex</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">lev_ex_1</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">20</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Fit a linear model with the modified data</span>
<span class="n">lev_fit_1</span> <span class="o">=</span> <span class="n">smf</span><span class="o">.</span><span class="n">ols</span><span class="p">(</span><span class="n">formula</span><span class="o">=</span><span class="s1">&#39;y ~ x1 + x2&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">lev_ex_1</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>Observa los <strong>grandes</strong> cambios en los coeficientes. Observe también que cada uno de los coeficientes ha cambiado de alguna manera. Nótese que los apalancamientos de los puntos no habrían cambiado, ya que no hemos modificado ninguno de los valores <span class="math notranslate nohighlight">\(x\)</span>.</p>
<p>Veamos ahora qué ocurre con estos coeficientes cuando modificamos el valor <code class="docutils literal notranslate"><span class="pre">y</span></code> del punto con menor apalancamiento.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Index of the observation with the minimum hat value</span>
<span class="n">min_hat_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">hat_values</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">min_hat_index</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>3
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Observation with the minimum hat value</span>
<span class="n">obs_min_hat</span> <span class="o">=</span> <span class="n">lev_ex</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">min_hat_index</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="n">obs_min_hat</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>x1     7
x2     3
y     14
Name: 3, dtype: int64
</pre></div>
</div>
</div>
</div>
<p>Vemos que el valor <code class="docutils literal notranslate"><span class="pre">y</span></code> original es 14. Crearemos de nuevo una copia de los datos, y modificaremos este punto para que tenga un valor <code class="docutils literal notranslate"><span class="pre">y</span></code> de <code class="docutils literal notranslate"><span class="pre">30</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create a modified copy of lev_ex with y[4] = 30</span>
<span class="n">lev_ex_2</span> <span class="o">=</span> <span class="n">lev_ex</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">lev_ex_2</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">30</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Fit a linear model with the modified data</span>
<span class="n">lev_fit_2</span> <span class="o">=</span> <span class="n">smf</span><span class="o">.</span><span class="n">ols</span><span class="p">(</span><span class="n">formula</span><span class="o">=</span><span class="s1">&#39;y ~ x1 + x2&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">lev_ex_2</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">lev_fit_2</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Intercept    5.7
x1          -0.7
x2           4.4
dtype: float64
</pre></div>
</div>
</div>
</div>
<p>Esta vez, a pesar de un gran cambio en el valor <code class="docutils literal notranslate"><span class="pre">y</span></code>, sólo hay un pequeño cambio en los coeficientes. Además, ¡sólo ha cambiado el intercepto!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mean_x1</span> <span class="o">=</span> <span class="n">lev_ex</span><span class="p">[</span><span class="s1">&#39;x1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">mean_x1</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>7.0
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mean_x2</span> <span class="o">=</span> <span class="n">lev_ex</span><span class="p">[</span><span class="s1">&#39;x2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">mean_x2</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>3.0
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Observation at index 4</span>
<span class="n">obs_4</span> <span class="o">=</span> <span class="n">lev_ex</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="n">obs_4</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>x1     7
x2     3
y     14
Name: 3, dtype: int64
</pre></div>
</div>
</div>
</div>
<p>Obsérvese que este punto era la media de ambos predictores.</p>
<p>Volviendo a nuestros tres gráficos, cada uno con un punto añadido, podemos calcular los apalancamientos de cada uno. Obsérvese que el undécimo punto de datos es cada vez el punto de datos añadido.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Hat values for model_1 , model_2 and model_3</span>
<span class="n">hat_values_model_1</span> <span class="o">=</span> <span class="n">model_1</span><span class="o">.</span><span class="n">get_influence</span><span class="p">()</span><span class="o">.</span><span class="n">hat_matrix_diag</span>

<span class="n">hat_values_model_1</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([0.33534597, 0.23860732, 0.16610842, 0.11784927, 0.09382988,
       0.09405024, 0.11851036, 0.16721022, 0.24014985, 0.33732922,
       0.09100926])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">hat_values_model_2</span> <span class="o">=</span> <span class="n">model_2</span><span class="o">.</span><span class="n">get_influence</span><span class="p">()</span><span class="o">.</span><span class="n">hat_matrix_diag</span>

<span class="n">hat_values_model_2</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([0.23238866, 0.18663968, 0.14979757, 0.12186235, 0.10283401,
       0.09271255, 0.09149798, 0.09919028, 0.11578947, 0.14129555,
       0.6659919 ])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">hat_values_model_3</span> <span class="o">=</span> <span class="n">model_3</span><span class="o">.</span><span class="n">get_influence</span><span class="p">()</span><span class="o">.</span><span class="n">hat_matrix_diag</span>

<span class="n">hat_values_model_3</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([0.27852761, 0.21411043, 0.16319018, 0.12576687, 0.10184049,
       0.09141104, 0.09447853, 0.11104294, 0.14110429, 0.18466258,
       0.49386503])
</pre></div>
</div>
</div>
</div>
<p>¿Alguno de ellos es grande?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Check if hat values are greater than 2 times the mean hat value</span>
<span class="n">is_high_leverage_model_1</span> <span class="o">=</span> <span class="n">hat_values_model_1</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">hat_values_model_1</span><span class="p">)</span>
<span class="n">is_high_leverage_model_2</span> <span class="o">=</span> <span class="n">hat_values_model_2</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">hat_values_model_2</span><span class="p">)</span>
<span class="n">is_high_leverage_model_3</span> <span class="o">=</span> <span class="n">hat_values_model_3</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">hat_values_model_3</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">is_high_leverage_model_1</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">is_high_leverage_model_2</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">is_high_leverage_model_3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[False False False False False False False False False False False]
[False False False False False False False False False False  True]
[False False False False False False False False False False  True]
</pre></div>
</div>
</div>
</div>
<p>Vemos que en el segundo y el tercer gráfico, el punto añadido es un punto de apalancamiento elevado. Recordemos que sólo en el tercer gráfico influyó en la regresión. Para entender por qué, tendremos que discutir los valores atípicos.</p>
</section>
<section id="valores-atipicos">
<h2>Valores atípicos<a class="headerlink" href="#valores-atipicos" title="Permalink to this heading">#</a></h2>
<p>Los valores atípicos son puntos que no se ajustan bien al modelo. Pueden o no tener un gran efecto en el modelo. Para identificar los valores atípicos, buscaremos observaciones con residuos grandes.</p>
<p>Nota,</p>
<div class="math notranslate nohighlight">
\[e = y - \hat{y} = Iy - Hy = (I - H) y\]</div>
<p>Entonces, bajo los supuestos de regresión lineal,</p>
<div class="math notranslate nohighlight">
\[ \text{Var}(e_i) = (1 - h_i) \sigma^2\]</div>
<p>y así estimar <span class="math notranslate nohighlight">\(\sigma^2\)</span> con <span class="math notranslate nohighlight">\(s_e^2\)</span> da</p>
<div class="math notranslate nohighlight">
\[\text{SE}[e_i] = s_e \sqrt{(1 - h_i)}.\]</div>
<p>Podemos entonces mirar el <strong>residuo estandarizado</strong> para cada observación, <span class="math notranslate nohighlight">\(i = 1, 2, \ldots n\)</span>,</p>
<div class="math notranslate nohighlight">
\[ r_i = \frac{e_i}{s_e\sqrt{1 - h_i}} \overset{approx}{\sim} N(\mu = 0, \sigma^ 2 = 1)\]</div>
<p>cuando <span class="math notranslate nohighlight">\(n\)</span> es grande.</p>
<p>Podemos utilizar este hecho para identificar residuos “grandes”. Por ejemplo, los residuos normalizados de magnitud superior a 2 sólo deberían producirse aproximadamente el 5% de las veces.</p>
<p>Volviendo de nuevo a nuestros tres gráficos, cada uno con un punto añadido, podemos calcular los residuos y los residuos normalizados de cada uno. Los residuos normalizados pueden obtenerse en <code class="docutils literal notranslate"><span class="pre">Python</span></code> utilizando <code class="docutils literal notranslate"><span class="pre">rstandard()</span></code> donde normalmente utilizaríamos <code class="docutils literal notranslate"><span class="pre">resid()</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Residuals for model_1</span>
<span class="n">residuals_model_1</span> <span class="o">=</span> <span class="n">model_1</span><span class="o">.</span><span class="n">resid</span>
<span class="nb">print</span><span class="p">(</span><span class="n">residuals_model_1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0    -0.457012
1    -1.079634
2    -0.281326
3     0.606371
4    -1.138456
5    -1.126084
6     0.699621
7    -0.099801
8    -1.324355
9    -0.299964
10    4.500639
dtype: float64
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Standardized residuals for model_1</span>
<span class="n">std_residuals_model_1</span> <span class="o">=</span> <span class="n">model_1</span><span class="o">.</span><span class="n">get_influence</span><span class="p">()</span><span class="o">.</span><span class="n">resid_studentized_internal</span>
<span class="nb">print</span><span class="p">(</span><span class="n">std_residuals_model_1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[-0.32373762 -0.71455583 -0.17791744  0.37284736 -0.69067754 -0.68325473
  0.4303465  -0.06315845 -0.87741313 -0.21280638  2.72620391]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Outliers for model_1 (standardized residuals &gt; 2)</span>

<span class="n">outliers_1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">std_residuals_model_1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="n">outliers_1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[10]
</pre></div>
</div>
</div>
</div>
<p>En el primer gráfico, vemos que el undécimo punto, el punto añadido, es un gran residuo normalizado.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Residuals for model_2</span>
<span class="n">residuals_model_2</span> <span class="o">=</span> <span class="n">model_2</span><span class="o">.</span><span class="n">resid</span>
<span class="nb">print</span><span class="p">(</span><span class="n">residuals_model_2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0     0.199922
1    -0.475635
2     0.269739
3     1.104501
4    -0.693261
5    -0.733824
6     1.038947
7     0.186590
8    -1.090899
9    -0.119443
10    0.313364
dtype: float64
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Standardized residuals for model_2</span>
<span class="n">std_residuals_model_2</span> <span class="o">=</span> <span class="n">model_2</span><span class="o">.</span><span class="n">get_influence</span><span class="p">()</span><span class="o">.</span><span class="n">resid_studentized_internal</span>
<span class="nb">print</span><span class="p">(</span><span class="n">std_residuals_model_2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[ 0.3063061  -0.70794147  0.39268736  1.58215744 -0.98248409 -1.03415204
  1.46317151  0.26389776 -1.5572971  -0.17302334  0.72783989]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Outliers for model_2 (standardized residuals &gt; 2)</span>

<span class="n">outliers_2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">std_residuals_model_2</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="n">outliers_2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[]
</pre></div>
</div>
</div>
</div>
<p>En el segundo gráfico, vemos que no hay puntos con residuos normalizados grandes.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Residuals for model_3</span>
<span class="n">residuals_model_3</span> <span class="o">=</span> <span class="n">model_3</span><span class="o">.</span><span class="n">resid</span>
<span class="nb">print</span><span class="p">(</span><span class="n">residuals_model_3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0     1.436729
1     0.406565
2     0.797332
3     1.277487
4    -0.874882
5    -1.270051
6     0.148113
7    -1.058851
8    -2.690946
9    -2.074097
10    3.902600
dtype: float64
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Standardized residuals for model_3</span>
<span class="n">std_residuals_model_3</span> <span class="o">=</span> <span class="n">model_3</span><span class="o">.</span><span class="n">get_influence</span><span class="p">()</span><span class="o">.</span><span class="n">resid_studentized_internal</span>
<span class="nb">print</span><span class="p">(</span><span class="n">std_residuals_model_3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[ 0.86029194  0.23325432  0.44330903  0.69490253 -0.46951936 -0.67767014
  0.07916351 -0.571183   -1.4767794  -1.16826475  2.78998477]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Outliers for model_3 (standardized residuals &gt; 2)</span>

<span class="n">outliers_3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">std_residuals_model_3</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="n">outliers_3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[10]
</pre></div>
</div>
</div>
</div>
<p>En el último gráfico, vemos que el undécimo punto, el punto añadido, es un residuo normalizado grande.</p>
<p>Recordemos que los puntos añadidos de los gráficos dos y tres eran ambos de alto apalancamiento, pero ahora sólo el punto del gráfico tres tiene un residuo grande. Ahora combinaremos esta información y discutiremos la influencia.</p>
</section>
<section id="influencia">
<h2>Influencia<a class="headerlink" href="#influencia" title="Permalink to this heading">#</a></h2>
<p>Como hemos visto en los tres gráficos, algunos valores atípicos sólo cambian ligeramente la regresión (gráfico uno) y otros tienen un gran efecto en la regresión (gráfico tres). Las observaciones que caen en esta última categoría, puntos con (alguna combinación de) <em>alto apalancamiento</em> <strong>y</strong> <em>gran residuo</em>, las llamaremos <strong>influyentes</strong>.</p>
<p>Una medida común de influencia es la <strong>distancia de Cook</strong>, que se define como</p>
<div class="math notranslate nohighlight">
\[ D_i = \frac{1}{p}r_i^2\frac{h_i}{1-{h_i}}.\]</div>
<p>Observe que es una función tanto del <em>apalancamiento</em> como de los <em>residuos normalizados</em>.</p>
<p>A menudo se considera que una distancia de Cook es grande si</p>
<div class="math notranslate nohighlight">
\[D_i &gt; \frac{4}{n}\]</div>
<p>y una observación con una gran distancia de Cook se denomina influyente. De nuevo, se trata simplemente de una heurística y no de una regla exacta.</p>
<p>La distancia de Cook para cada punto de una regresión se puede calcular utilizando <code class="docutils literal notranslate"><span class="pre">cooks.distance()</span></code> que es una función por defecto en <code class="docutils literal notranslate"><span class="pre">Python</span></code>. Busquemos puntos influyentes en los tres gráficos que hemos estado considerando.</p>
<p>```{r, ref.label=“unusual_obs_plot”, fig.height = 5, fig.width = 15,
echo = FALSE}</p>
<p>Recuerde que los puntos marcados con un círculo en cada gráfico tienen características diferentes:</p>
<ul class="simple">
<li><p>Primer gráfico: apalancamiento bajo, residuo grande.</p></li>
<li><p>Gráfico 2: apalancamiento alto, residuo pequeño.</p></li>
<li><p>Tercer gráfico: apalancamiento alto, residuo grande.
Ahora comprobaremos directamente si cada uno de ellos es influyente.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">statsmodels.stats.outliers_influence</span> <span class="kn">import</span> <span class="n">OLSInfluence</span>

<span class="c1"># Calculate Cook&#39;s distance for model_1, model_2, and model_3</span>
<span class="n">cooks_distance_1</span> <span class="o">=</span> <span class="n">model_1</span><span class="o">.</span><span class="n">get_influence</span><span class="p">()</span><span class="o">.</span><span class="n">cooks_distance</span>
<span class="n">cooks_distance_2</span> <span class="o">=</span> <span class="n">model_2</span><span class="o">.</span><span class="n">get_influence</span><span class="p">()</span><span class="o">.</span><span class="n">cooks_distance</span>
<span class="n">cooks_distance_3</span> <span class="o">=</span> <span class="n">model_3</span><span class="o">.</span><span class="n">get_influence</span><span class="p">()</span><span class="o">.</span><span class="n">cooks_distance</span>

<span class="c1"># Calculate the threshold for Cook&#39;s distance using the length of cooks_distance_1[0]</span>
<span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cooks_distance_1</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">threshold</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">/</span> <span class="n">n</span>

<span class="c1"># Check if the Cook&#39;s distance for the 11th observation exceeds the threshold for each model</span>
<span class="n">is_outlier_model_1</span> <span class="o">=</span> <span class="n">cooks_distance_1</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">10</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">threshold</span>
<span class="n">is_outlier_model_2</span> <span class="o">=</span> <span class="n">cooks_distance_2</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">10</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">threshold</span>
<span class="n">is_outlier_model_3</span> <span class="o">=</span> <span class="n">cooks_distance_3</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">10</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">threshold</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Is 11th observation an outlier in model_1?&quot;</span><span class="p">,</span> <span class="n">is_outlier_model_1</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Is 11th observation an outlier in model_2?&quot;</span><span class="p">,</span> <span class="n">is_outlier_model_2</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Is 11th observation an outlier in model_3?&quot;</span><span class="p">,</span> <span class="n">is_outlier_model_3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Is 11th observation an outlier in model_1? True
Is 11th observation an outlier in model_2? True
Is 11th observation an outlier in model_3? True
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cooks_distance_1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([0.02643953, 0.08000505, 0.00315275, 0.00928573, 0.02469745,
       0.0242321 , 0.01244932, 0.00040046, 0.12165574, 0.01152645,
       0.37205982])
</pre></div>
</div>
</div>
</div>
<p>Y, como era de esperar, el punto añadido en el tercer gráfico, con un apalancamiento alto y un residuo grande, ¡se considera influyente!</p>
</section>
</section>
<section id="ejemplos-de-analisis-de-datos">
<h1>Ejemplos de análisis de datos<a class="headerlink" href="#ejemplos-de-analisis-de-datos" title="Permalink to this heading">#</a></h1>
<section id="buenos-diagnosticos">
<h2>Buenos diagnósticos<a class="headerlink" href="#buenos-diagnosticos" title="Permalink to this heading">#</a></h2>
<p>En el capítulo anterior ajustamos una regresión aditiva a los datos de <code class="docutils literal notranslate"><span class="pre">mtcars</span></code> con <code class="docutils literal notranslate"><span class="pre">mpg</span></code> como respuesta y <code class="docutils literal notranslate"><span class="pre">hp</span></code> y <code class="docutils literal notranslate"><span class="pre">am</span></code> como predictores. Vamos a realizar algunos diagnósticos en este modelo.</p>
<p>En primer lugar, ajuste el modelo como lo hicimos en el capítulo anterior.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pip</span> <span class="n">install</span> <span class="n">pydataset</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Defaulting to user installation because normal site-packages is not writeable
Collecting pydataset
  Downloading pydataset-0.2.0.tar.gz (15.9 MB)
     -------------------------------------- 15.9/15.9 MB 392.8 kB/s eta 0:00:00
  Preparing metadata (setup.py): started
  Preparing metadata (setup.py): finished with status &#39;done&#39;
Requirement already satisfied: pandas in c:\programdata\anaconda3\lib\site-packages (from pydataset) (1.4.4)
Requirement already satisfied: python-dateutil&gt;=2.8.1 in c:\users\a.tabaresp\appdata\roaming\python\python39\site-packages (from pandas-&gt;pydataset) (2.8.2)
Requirement already satisfied: numpy&gt;=1.18.5 in c:\programdata\anaconda3\lib\site-packages (from pandas-&gt;pydataset) (1.21.5)
Requirement already satisfied: pytz&gt;=2020.1 in c:\programdata\anaconda3\lib\site-packages (from pandas-&gt;pydataset) (2022.1)
Requirement already satisfied: six&gt;=1.5 in c:\users\a.tabaresp\appdata\roaming\python\python39\site-packages (from python-dateutil&gt;=2.8.1-&gt;pandas-&gt;pydataset) (1.16.0)
Building wheels for collected packages: pydataset
  Building wheel for pydataset (setup.py): started
  Building wheel for pydataset (setup.py): finished with status &#39;done&#39;
  Created wheel for pydataset: filename=pydataset-0.2.0-py3-none-any.whl size=15939417 sha256=5898ec5a096b237f08bf856f766d95dda3ffe8b1b58e8f9c1f2e85c6bd8d69af
  Stored in directory: c:\users\a.tabaresp\appdata\local\pip\cache\wheels\6b\86\a7\f71cb84c7bff804d83e293615a20c0531234397b796aee2645
Successfully built pydataset
Installing collected packages: pydataset
Successfully installed pydataset-0.2.0
Note: you may need to restart the kernel to use updated packages.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">statsmodels.api</span> <span class="k">as</span> <span class="nn">sm</span>
<span class="kn">import</span> <span class="nn">statsmodels.formula.api</span> <span class="k">as</span> <span class="nn">smf</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">stats</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="c1"># Since mtcars is an R dataset, we need to import it separately</span>
<span class="kn">from</span> <span class="nn">pydataset</span> <span class="kn">import</span> <span class="n">data</span>
<span class="n">mtcars</span> <span class="o">=</span> <span class="n">data</span><span class="p">(</span><span class="s1">&#39;mtcars&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>initiated datasets repo at: C:\Users\a.tabaresp\.pydataset/
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mpg_hp_add</span> <span class="o">=</span> <span class="n">smf</span><span class="o">.</span><span class="n">ols</span><span class="p">(</span><span class="s1">&#39;mpg ~ hp + am&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">mtcars</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">mpg_hp_add</span><span class="o">.</span><span class="n">fittedvalues</span><span class="p">,</span> <span class="n">mpg_hp_add</span><span class="o">.</span><span class="n">resid</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkorange&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Fitted&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Residual&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;mtcars: Fitted versus Residuals&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/6a544976aeb84c991d6fe3f75320ce5f418dccd3a8c8ede4858aeebfe913a0fd.png" src="../_images/6a544976aeb84c991d6fe3f75320ce5f418dccd3a8c8ede4858aeebfe913a0fd.png" />
</div>
</div>
<p>El gráfico de ajuste frente a los residuos tiene buen aspecto. No vemos ningún patrón obvio, y la varianza parece más o menos constante. (Quizá un poco mayor para valores ajustados grandes, pero no lo suficiente como para preocuparse).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">bp_test</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">diagnostic</span><span class="o">.</span><span class="n">het_breuschpagan</span><span class="p">(</span><span class="n">mpg_hp_add</span><span class="o">.</span><span class="n">resid</span><span class="p">,</span> <span class="n">mpg_hp_add</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">exog</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;BP test statistic: </span><span class="si">{</span><span class="n">bp_test</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;BP test p-value: </span><span class="si">{</span><span class="n">bp_test</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>BP test statistic: 7.585795388761319
BP test p-value: 0.02253022147453308
</pre></div>
</div>
</div>
</div>
<p>La prueba de Breusch-Pagan lo verifica, al menos para un valor <span class="math notranslate nohighlight">\(\alpha\)</span> pequeño.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">stats</span><span class="o">.</span><span class="n">probplot</span><span class="p">(</span><span class="n">mpg_hp_add</span><span class="o">.</span><span class="n">resid</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="n">plt</span><span class="p">,</span> <span class="n">fit</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/0767e9f0ef1d6d5bb3b7eba53ea9ba7914309b08b231e7b0235761d508457238.png" src="../_images/0767e9f0ef1d6d5bb3b7eba53ea9ba7914309b08b231e7b0235761d508457238.png" />
</div>
</div>
<p>El gráfico Q-Q tiene muy buen aspecto y la prueba de Shapiro Wilk está de acuerdo.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">shapiro_test</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">shapiro</span><span class="p">(</span><span class="n">mpg_hp_add</span><span class="o">.</span><span class="n">resid</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Shapiro test statistic: </span><span class="si">{</span><span class="n">shapiro_test</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Shapiro test p-value: </span><span class="si">{</span><span class="n">shapiro_test</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Shapiro test statistic: 0.9648544788360596
Shapiro test p-value: 0.3706476092338562
</pre></div>
</div>
</div>
</div>
<p>Vemos que hay dos puntos de gran apalancamiento.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">hat_values</span> <span class="o">=</span> <span class="n">mpg_hp_add</span><span class="o">.</span><span class="n">get_influence</span><span class="p">()</span><span class="o">.</span><span class="n">hat_matrix_diag</span>
<span class="n">high_leverage_points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">hat_values</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">hat_values</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">high_leverage_points</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">std_residuals</span> <span class="o">=</span> <span class="n">mpg_hp_add</span><span class="o">.</span><span class="n">get_influence</span><span class="p">()</span><span class="o">.</span><span class="n">resid_studentized_internal</span>
<span class="n">high_std_resid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">std_residuals</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">high_std_resid</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1
</pre></div>
</div>
</div>
</div>
<p>También hay un punto con un gran residuo. ¿Resultan puntos que se consideren influyentes?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cooks_d</span> <span class="o">=</span> <span class="n">mpg_hp_add</span><span class="o">.</span><span class="n">get_influence</span><span class="p">()</span><span class="o">.</span><span class="n">cooks_distance</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">influential_points</span> <span class="o">=</span> <span class="n">cooks_d</span> <span class="o">&gt;</span> <span class="mi">4</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">cooks_d</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">influential_points</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2
</pre></div>
</div>
</div>
</div>
<p>Encontramos dos puntos influyentes. Curiosamente, son coches <strong>muy</strong> diferentes.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">mpg_hp_add</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Intercept    26.584914
hp           -0.058888
am            5.277085
dtype: float64
</pre></div>
</div>
</div>
</div>
<p>Como los diagnósticos parecían buenos, no hay que preocuparse mucho por estos dos puntos, pero veamos cuánto cambian los coeficientes si los eliminamos.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Filtering out influential points</span>
<span class="n">filtered_data</span> <span class="o">=</span> <span class="n">mtcars</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="o">~</span><span class="n">influential_points</span><span class="p">]</span>

<span class="c1"># Fitting the model again</span>
<span class="n">mpg_hp_add_fix</span> <span class="o">=</span> <span class="n">smf</span><span class="o">.</span><span class="n">ols</span><span class="p">(</span><span class="s1">&#39;mpg ~ hp + am&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">filtered_data</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">mpg_hp_add_fix</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Intercept    27.221909
hp           -0.062862
am            4.297659
dtype: float64
</pre></div>
</div>
</div>
</div>
<p>Parece que no hay grandes cambios en los coeficientes como resultado de la eliminación de los supuestos puntos influyentes.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">graphics</span><span class="o">.</span><span class="n">plot_regress_exog</span><span class="p">(</span><span class="n">mpg_hp_add</span><span class="p">,</span> <span class="s1">&#39;hp&#39;</span><span class="p">,</span> <span class="n">fig</span><span class="o">=</span><span class="n">fig</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>eval_env: 1
</pre></div>
</div>
<img alt="../_images/f231d74427e16b8694f8d5e74948a12c3108383583188353ff9d2de93c9a85d2.png" src="../_images/f231d74427e16b8694f8d5e74948a12c3108383583188353ff9d2de93c9a85d2.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># base code</span>
<span class="kn">import</span> <span class="nn">statsmodels</span>
<span class="kn">import</span> <span class="nn">statsmodels.formula.api</span> <span class="k">as</span> <span class="nn">smf</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">from</span> <span class="nn">statsmodels.tools.tools</span> <span class="kn">import</span> <span class="n">maybe_unwrap_results</span>
<span class="kn">from</span> <span class="nn">statsmodels.graphics.gofplots</span> <span class="kn">import</span> <span class="n">ProbPlot</span>
<span class="kn">from</span> <span class="nn">statsmodels.stats.outliers_influence</span> <span class="kn">import</span> <span class="n">variance_inflation_factor</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Type</span>

<span class="n">style_talk</span> <span class="o">=</span> <span class="s1">&#39;seaborn-talk&#39;</span>    <span class="c1">#refer to plt.style.available</span>

<span class="k">class</span> <span class="nc">LinearRegDiagnostic</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Diagnostic plots to identify potential problems in a linear regression fit.</span>
<span class="sd">    Mainly,</span>
<span class="sd">        a. non-linearity of data</span>
<span class="sd">        b. Correlation of error terms</span>
<span class="sd">        c. non-constant variance</span>
<span class="sd">        d. outliers</span>
<span class="sd">        e. high-leverage points</span>
<span class="sd">        f. collinearity</span>

<span class="sd">    Authors:</span>
<span class="sd">        Prajwal Kafle (p33ajkafle@gmail.com, where 3 = r)</span>
<span class="sd">        Does not come with any sort of warranty.</span>
<span class="sd">        Please test the code one your end before using.</span>

<span class="sd">        Matt Spinelli (m3spinelli@gmail.com, where 3 = r)</span>
<span class="sd">        (1) Fixed incorrect annotation of the top most extreme residuals in</span>
<span class="sd">            the Residuals vs Fitted and, especially, the Normal Q-Q plots.</span>
<span class="sd">        (2) Changed Residuals vs Leverage plot to match closer the y-axis</span>
<span class="sd">            range shown in the equivalent plot in the R package ggfortify.</span>
<span class="sd">        (3) Added horizontal line at y=0 in Residuals vs Leverage plot to</span>
<span class="sd">            match the plots in R package ggfortify and base R.</span>
<span class="sd">        (4) Added option for placing a vertical guideline on the Residuals</span>
<span class="sd">            vs Leverage plot using the rule of thumb of h = 2p/n to denote</span>
<span class="sd">            high leverage (high_leverage_threshold=True).</span>
<span class="sd">        (5) Added two more ways to compute the Cook&#39;s Distance (D) threshold:</span>
<span class="sd">            * &#39;baseR&#39;: D &gt; 1 and D &gt; 0.5 (default)</span>
<span class="sd">            * &#39;convention&#39;: D &gt; 4/n</span>
<span class="sd">            * &#39;dof&#39;: D &gt; 4 / (n - k - 1)</span>
<span class="sd">        (6) Fixed class name to conform to Pascal casing convention</span>
<span class="sd">        (7) Fixed Residuals vs Leverage legend to work with loc=&#39;best&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">results</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">statsmodels</span><span class="o">.</span><span class="n">regression</span><span class="o">.</span><span class="n">linear_model</span><span class="o">.</span><span class="n">RegressionResultsWrapper</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        For a linear regression model, generates following diagnostic plots:</span>

<span class="sd">        a. residual</span>
<span class="sd">        b. qq</span>
<span class="sd">        c. scale location and</span>
<span class="sd">        d. leverage</span>

<span class="sd">        and a table</span>

<span class="sd">        e. vif</span>

<span class="sd">        Args:</span>
<span class="sd">            results (Type[statsmodels.regression.linear_model.RegressionResultsWrapper]):</span>
<span class="sd">                must be instance of statsmodels.regression.linear_model object</span>

<span class="sd">        Raises:</span>
<span class="sd">            TypeError: if instance does not belong to above object</span>

<span class="sd">        Example:</span>
<span class="sd">        &gt;&gt;&gt; import numpy as np</span>
<span class="sd">        &gt;&gt;&gt; import pandas as pd</span>
<span class="sd">        &gt;&gt;&gt; import statsmodels.formula.api as smf</span>
<span class="sd">        &gt;&gt;&gt; x = np.linspace(-np.pi, np.pi, 100)</span>
<span class="sd">        &gt;&gt;&gt; y = 3*x + 8 + np.random.normal(0,1, 100)</span>
<span class="sd">        &gt;&gt;&gt; df = pd.DataFrame({&#39;x&#39;:x, &#39;y&#39;:y})</span>
<span class="sd">        &gt;&gt;&gt; res = smf.ols(formula= &quot;y ~ x&quot;, data=df).fit()</span>
<span class="sd">        &gt;&gt;&gt; cls = Linear_Reg_Diagnostic(res)</span>
<span class="sd">        &gt;&gt;&gt; cls(plot_context=&quot;seaborn-paper&quot;)</span>

<span class="sd">        In case you do not need all plots you can also independently make an individual plot/table</span>
<span class="sd">        in following ways</span>

<span class="sd">        &gt;&gt;&gt; cls = Linear_Reg_Diagnostic(res)</span>
<span class="sd">        &gt;&gt;&gt; cls.residual_plot()</span>
<span class="sd">        &gt;&gt;&gt; cls.qq_plot()</span>
<span class="sd">        &gt;&gt;&gt; cls.scale_location_plot()</span>
<span class="sd">        &gt;&gt;&gt; cls.leverage_plot()</span>
<span class="sd">        &gt;&gt;&gt; cls.vif_table()</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">statsmodels</span><span class="o">.</span><span class="n">regression</span><span class="o">.</span><span class="n">linear_model</span><span class="o">.</span><span class="n">RegressionResultsWrapper</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;result must be instance of statsmodels.regression.linear_model.RegressionResultsWrapper object&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="o">=</span> <span class="n">maybe_unwrap_results</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">y_true</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">endog</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y_predict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">fittedvalues</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xvar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">exog</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xvar_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">exog_names</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">residual</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">resid</span><span class="p">)</span>
        <span class="n">influence</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">get_influence</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">residual_norm</span> <span class="o">=</span> <span class="n">influence</span><span class="o">.</span><span class="n">resid_studentized_internal</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">leverage</span> <span class="o">=</span> <span class="n">influence</span><span class="o">.</span><span class="n">hat_matrix_diag</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cooks_distance</span> <span class="o">=</span> <span class="n">influence</span><span class="o">.</span><span class="n">cooks_distance</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nparams</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nresids</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">residual_norm</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plot_context</span><span class="o">=</span><span class="s1">&#39;seaborn-paper&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># print(plt.style.available)</span>
        <span class="k">with</span> <span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">context</span><span class="p">(</span><span class="n">plot_context</span><span class="p">):</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">residual_plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">qq_plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scale_location_plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">leverage_plot</span><span class="p">(</span>
                <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span>
                <span class="n">high_leverage_threshold</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;high_leverage_threshold&#39;</span><span class="p">),</span>
                <span class="n">cooks_threshold</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;cooks_threshold&#39;</span><span class="p">))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">vif_table</span><span class="p">(),</span> <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span>

    <span class="k">def</span> <span class="nf">residual_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Residual vs Fitted Plot</span>

<span class="sd">        Graphical tool to identify non-linearity.</span>
<span class="sd">        (Roughly) Horizontal red line is an indicator that the residual has a linear pattern</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>

        <span class="n">sns</span><span class="o">.</span><span class="n">residplot</span><span class="p">(</span>
            <span class="n">x</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">y_predict</span><span class="p">,</span>
            <span class="n">y</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">residual</span><span class="p">,</span>
            <span class="n">lowess</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">scatter_kws</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;alpha&#39;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">},</span>
            <span class="n">line_kws</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;color&#39;</span><span class="p">:</span> <span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="s1">&#39;lw&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;alpha&#39;</span><span class="p">:</span> <span class="mf">0.8</span><span class="p">},</span>
            <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>

        <span class="c1"># annotations</span>
        <span class="n">residual_abs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">residual</span><span class="p">)</span>
        <span class="n">abs_resid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">residual_abs</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">abs_resid_top_3</span> <span class="o">=</span> <span class="n">abs_resid</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">abs_resid_top_3</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
                <span class="n">i</span><span class="p">,</span>
                <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y_predict</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">residual</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span>
                <span class="n">color</span><span class="o">=</span><span class="s1">&#39;C3&#39;</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Residuals vs Fitted&#39;</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s2">&quot;bold&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Fitted values&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Residuals&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ax</span>

    <span class="k">def</span> <span class="nf">qq_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Standarized Residual vs Theoretical Quantile plot</span>

<span class="sd">        Used to visually check if residuals are normally distributed.</span>
<span class="sd">        Points spread along the diagonal line will suggest so.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>

        <span class="n">QQ</span> <span class="o">=</span> <span class="n">ProbPlot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">residual_norm</span><span class="p">)</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">QQ</span><span class="o">.</span><span class="n">qqplot</span><span class="p">(</span><span class="n">line</span><span class="o">=</span><span class="s1">&#39;45&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>

        <span class="c1"># annotations</span>
        <span class="n">abs_norm_resid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">residual_norm</span><span class="p">)),</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">abs_norm_resid_top_3</span> <span class="o">=</span> <span class="n">abs_norm_resid</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__qq_top_resid</span><span class="p">(</span><span class="n">QQ</span><span class="o">.</span><span class="n">theoretical_quantiles</span><span class="p">,</span> <span class="n">abs_norm_resid_top_3</span><span class="p">):</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
                <span class="n">i</span><span class="p">,</span>
                <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span>
                <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="s1">&#39;C3&#39;</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Normal Q-Q&#39;</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s2">&quot;bold&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Theoretical Quantiles&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Standardized Residuals&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ax</span>

    <span class="k">def</span> <span class="nf">scale_location_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sqrt(Standarized Residual) vs Fitted values plot</span>

<span class="sd">        Used to check homoscedasticity of the residuals.</span>
<span class="sd">        Horizontal line will suggest so.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>

        <span class="n">residual_norm_abs_sqrt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">residual_norm</span><span class="p">))</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y_predict</span><span class="p">,</span> <span class="n">residual_norm_abs_sqrt</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">);</span>
        <span class="n">sns</span><span class="o">.</span><span class="n">regplot</span><span class="p">(</span>
            <span class="n">x</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">y_predict</span><span class="p">,</span>
            <span class="n">y</span><span class="o">=</span><span class="n">residual_norm_abs_sqrt</span><span class="p">,</span>
            <span class="n">scatter</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ci</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">lowess</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">line_kws</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;color&#39;</span><span class="p">:</span> <span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="s1">&#39;lw&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;alpha&#39;</span><span class="p">:</span> <span class="mf">0.8</span><span class="p">},</span>
            <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>

        <span class="c1"># annotations</span>
        <span class="n">abs_sq_norm_resid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">residual_norm_abs_sqrt</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">abs_sq_norm_resid_top_3</span> <span class="o">=</span> <span class="n">abs_sq_norm_resid</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">abs_sq_norm_resid_top_3</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
                <span class="n">i</span><span class="p">,</span>
                <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y_predict</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">residual_norm_abs_sqrt</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span>
                <span class="n">color</span><span class="o">=</span><span class="s1">&#39;C3&#39;</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Scale-Location&#39;</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s2">&quot;bold&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Fitted values&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\sqrt{|\mathrm{Standardized\ Residuals}|}$&#39;</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">ax</span>

    <span class="k">def</span> <span class="nf">leverage_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">high_leverage_threshold</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cooks_threshold</span><span class="o">=</span><span class="s1">&#39;baseR&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Residual vs Leverage plot</span>

<span class="sd">        Points falling outside Cook&#39;s distance curves are considered observation that can sway the fit</span>
<span class="sd">        aka are influential.</span>
<span class="sd">        Good to have none outside the curves.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">leverage</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">residual_norm</span><span class="p">,</span>
            <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">);</span>

        <span class="n">sns</span><span class="o">.</span><span class="n">regplot</span><span class="p">(</span>
            <span class="n">x</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">leverage</span><span class="p">,</span>
            <span class="n">y</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">residual_norm</span><span class="p">,</span>
            <span class="n">scatter</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">ci</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">lowess</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">line_kws</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;color&#39;</span><span class="p">:</span> <span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="s1">&#39;lw&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;alpha&#39;</span><span class="p">:</span> <span class="mf">0.8</span><span class="p">},</span>
            <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>

        <span class="c1"># annotations</span>
        <span class="n">leverage_top_3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cooks_distance</span><span class="p">),</span> <span class="mi">0</span><span class="p">)[:</span><span class="mi">3</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">leverage_top_3</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
                <span class="n">i</span><span class="p">,</span>
                <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">leverage</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">residual_norm</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span>
                <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;C3&#39;</span><span class="p">)</span>

        <span class="n">factors</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">cooks_threshold</span> <span class="o">==</span> <span class="s1">&#39;baseR&#39;</span> <span class="ow">or</span> <span class="n">cooks_threshold</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">factors</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">cooks_threshold</span> <span class="o">==</span> <span class="s1">&#39;convention&#39;</span><span class="p">:</span>
            <span class="n">factors</span> <span class="o">=</span> <span class="p">[</span><span class="mi">4</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">nresids</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">cooks_threshold</span> <span class="o">==</span> <span class="s1">&#39;dof&#39;</span><span class="p">:</span>
            <span class="n">factors</span> <span class="o">=</span> <span class="p">[</span><span class="mi">4</span><span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nresids</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">nparams</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;threshold_method must be one of the following: &#39;convention&#39;, &#39;dof&#39;, or &#39;baseR&#39; (default)&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">factor</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">factors</span><span class="p">):</span>
            <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;Cook&#39;s distance&quot;</span> <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="n">xtemp</span><span class="p">,</span> <span class="n">ytemp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__cooks_dist_line</span><span class="p">(</span><span class="n">factor</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xtemp</span><span class="p">,</span> <span class="n">ytemp</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">1.25</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xtemp</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">negative</span><span class="p">(</span><span class="n">ytemp</span><span class="p">),</span> <span class="n">lw</span><span class="o">=</span><span class="mf">1.25</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">high_leverage_threshold</span><span class="p">:</span>
            <span class="n">high_leverage</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nparams</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">nresids</span>
            <span class="k">if</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">leverage</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">high_leverage</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">high_leverage</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;High leverage&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;-.&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;purple&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;dotted&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">1.25</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">leverage</span><span class="p">)</span><span class="o">+</span><span class="mf">0.01</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">residual_norm</span><span class="p">)</span><span class="o">-</span><span class="mf">0.1</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">residual_norm</span><span class="p">)</span><span class="o">+</span><span class="mf">0.1</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Residuals vs Leverage&#39;</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s2">&quot;bold&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Leverage&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Standardized Residuals&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ax</span>

    <span class="k">def</span> <span class="nf">vif_table</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        VIF table</span>

<span class="sd">        VIF, the variance inflation factor, is a measure of multicollinearity.</span>
<span class="sd">        VIF &gt; 5 for a variable indicates that it is highly collinear with the</span>
<span class="sd">        other input variables.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">vif_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        <span class="n">vif_df</span><span class="p">[</span><span class="s2">&quot;Features&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xvar_names</span>
        <span class="n">vif_df</span><span class="p">[</span><span class="s2">&quot;VIF Factor&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">variance_inflation_factor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xvar</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xvar</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">vif_df</span>
                <span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;VIF Factor&quot;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>


    <span class="k">def</span> <span class="nf">__cooks_dist_line</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">factor</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Helper function for plotting Cook&#39;s distance curves</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nparams</span>
        <span class="n">formula</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">factor</span> <span class="o">*</span> <span class="n">p</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">x</span><span class="p">))</span> <span class="o">/</span> <span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.001</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">leverage</span><span class="p">),</span> <span class="mi">50</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">formula</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span>


    <span class="k">def</span> <span class="nf">__qq_top_resid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">quantiles</span><span class="p">,</span> <span class="n">top_residual_indices</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Helper generator function yielding the index and coordinates</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">quant_index</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">previous_is_negative</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">resid_index</span> <span class="ow">in</span> <span class="n">top_residual_indices</span><span class="p">:</span>
            <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">residual_norm</span><span class="p">[</span><span class="n">resid_index</span><span class="p">]</span>
            <span class="n">is_negative</span> <span class="o">=</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="n">previous_is_negative</span> <span class="o">==</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">previous_is_negative</span> <span class="o">==</span> <span class="n">is_negative</span><span class="p">:</span>
                <span class="n">offset</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">quant_index</span> <span class="o">-=</span> <span class="n">offset</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">quantiles</span><span class="p">[</span><span class="n">quant_index</span><span class="p">]</span> <span class="k">if</span> <span class="n">is_negative</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">quantiles</span><span class="p">,</span> <span class="mi">0</span><span class="p">)[</span><span class="n">quant_index</span><span class="p">]</span>
            <span class="n">quant_index</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">previous_is_negative</span> <span class="o">=</span> <span class="n">is_negative</span>
            <span class="k">yield</span> <span class="n">resid_index</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="bp">cls</span> <span class="o">=</span> <span class="n">LinearRegDiagnostic</span><span class="p">(</span><span class="n">mpg_hp_add</span><span class="p">)</span>
<span class="n">vif</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/93ad1963d88f808b5f42153c755163bcbf75d8c653a722494d574bf647d9a64b.png" src="../_images/93ad1963d88f808b5f42153c755163bcbf75d8c653a722494d574bf647d9a64b.png" />
</div>
</div>
</section>
<section id="diagnosticos-sospechosos">
<h2>Diagnósticos sospechosos<a class="headerlink" href="#diagnosticos-sospechosos" title="Permalink to this heading">#</a></h2>
<p>Consideremos el modelo <code class="docutils literal notranslate"><span class="pre">big_model</span></code> del último capítulo que se ajustó al conjunto de datos <code class="docutils literal notranslate"><span class="pre">autompg</span></code>. Utilizó <code class="docutils literal notranslate"><span class="pre">mpg</span></code> como respuesta, y consideró muchos términos de interacción entre los predictores <code class="docutils literal notranslate"><span class="pre">disp</span></code>, <code class="docutils literal notranslate"><span class="pre">hp</span></code>, y <code class="docutils literal notranslate"><span class="pre">domestic</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Read data frame from the web</span>
<span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;http://archive.ics.uci.edu/ml/machine-learning-databases/auto-mpg/auto-mpg.data&quot;</span>
<span class="n">autompg</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;\s+&quot;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">comment</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">quotechar</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">na_values</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;?&quot;</span><span class="p">])</span>

<span class="c1"># Assign headers to the dataframe</span>
<span class="n">autompg</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;mpg&quot;</span><span class="p">,</span> <span class="s2">&quot;cyl&quot;</span><span class="p">,</span> <span class="s2">&quot;disp&quot;</span><span class="p">,</span> <span class="s2">&quot;hp&quot;</span><span class="p">,</span> <span class="s2">&quot;wt&quot;</span><span class="p">,</span> <span class="s2">&quot;acc&quot;</span><span class="p">,</span> <span class="s2">&quot;year&quot;</span><span class="p">,</span> <span class="s2">&quot;origin&quot;</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">]</span>

<span class="c1"># Remove rows with missing &#39;hp&#39; data</span>
<span class="n">autompg</span> <span class="o">=</span> <span class="n">autompg</span><span class="p">[</span><span class="n">autompg</span><span class="p">[</span><span class="s1">&#39;hp&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">notna</span><span class="p">()]</span>

<span class="c1"># Remove &#39;plymouth reliant&#39;</span>
<span class="n">autompg</span> <span class="o">=</span> <span class="n">autompg</span><span class="p">[</span><span class="n">autompg</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;plymouth reliant&quot;</span><span class="p">]</span>

<span class="c1"># Create row names based on the engine, year, and name</span>
<span class="n">autompg</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">autompg</span><span class="p">[</span><span class="s1">&#39;cyl&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; cylinder &quot;</span> <span class="o">+</span> <span class="n">autompg</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">autompg</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>

<span class="c1"># Drop the &#39;name&#39; column</span>
<span class="n">autompg</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Convert horsepower from object to numeric</span>
<span class="n">autompg</span><span class="p">[</span><span class="s1">&#39;hp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_numeric</span><span class="p">(</span><span class="n">autompg</span><span class="p">[</span><span class="s1">&#39;hp&#39;</span><span class="p">],</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;coerce&#39;</span><span class="p">)</span>

<span class="c1"># Create a dummy variable for foreign vs. domestic cars. Domestic = 1.</span>
<span class="n">autompg</span><span class="p">[</span><span class="s1">&#39;domestic&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">autompg</span><span class="p">[</span><span class="s1">&#39;origin&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

<span class="c1"># Remove 3 and 5 cylinder cars</span>
<span class="n">autompg</span> <span class="o">=</span> <span class="n">autompg</span><span class="p">[</span><span class="o">~</span><span class="n">autompg</span><span class="p">[</span><span class="s1">&#39;cyl&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">])]</span>

<span class="c1"># Change &#39;cyl&#39; to a category variable</span>
<span class="n">autompg</span><span class="p">[</span><span class="s1">&#39;cyl&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">autompg</span><span class="p">[</span><span class="s1">&#39;cyl&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;category&#39;</span><span class="p">)</span>

<span class="c1"># Display the structure (similar to str in R)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">autompg</span><span class="o">.</span><span class="n">info</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;class &#39;pandas.core.frame.DataFrame&#39;&gt;
Index: 383 entries, 8 cylinder 70 chevrolet chevelle malibu to 4 cylinder 82 chevy s-10
Data columns (total 9 columns):
 #   Column    Non-Null Count  Dtype   
---  ------    --------------  -----   
 0   mpg       383 non-null    float64 
 1   cyl       383 non-null    category
 2   disp      383 non-null    float64 
 3   hp        383 non-null    float64 
 4   wt        383 non-null    float64 
 5   acc       383 non-null    float64 
 6   year      383 non-null    int64   
 7   origin    383 non-null    int64   
 8   domestic  383 non-null    int32   
dtypes: category(1), float64(5), int32(1), int64(2)
memory usage: 25.9+ KB
None
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">big_model</span> <span class="o">=</span> <span class="n">smf</span><span class="o">.</span><span class="n">ols</span><span class="p">(</span><span class="s1">&#39;mpg ~ disp * hp * domestic&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">autompg</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">stats</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="n">stats</span><span class="o">.</span><span class="n">probplot</span><span class="p">(</span><span class="n">big_model</span><span class="o">.</span><span class="n">resid</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="n">plt</span><span class="p">,</span> <span class="n">fit</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/e02411903c720735041aef0205a078ddbbf2b603aea59b5fb82cd338920e52c4.png" src="../_images/e02411903c720735041aef0205a078ddbbf2b603aea59b5fb82cd338920e52c4.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">shapiro_test</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">shapiro</span><span class="p">(</span><span class="n">big_model</span><span class="o">.</span><span class="n">resid</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Shapiro test statistic: </span><span class="si">{</span><span class="n">shapiro_test</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Shapiro test p-value: </span><span class="si">{</span><span class="n">shapiro_test</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Shapiro test statistic: 0.9616078734397888
Shapiro test p-value: 1.8245273736283707e-08
</pre></div>
</div>
</div>
</div>
<p>En este caso, tanto el gráfico Q-Q como la prueba de Shapiro-Wilk sugieren que se incumple el supuesto de normalidad.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cooks_d</span> <span class="o">=</span> <span class="n">big_model</span><span class="o">.</span><span class="n">get_influence</span><span class="p">()</span><span class="o">.</span><span class="n">cooks_distance</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">influential_points</span> <span class="o">=</span> <span class="n">cooks_d</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mi">4</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">cooks_d</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">influential_points</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>31
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">residuos_plot</span> <span class="o">=</span> <span class="n">LinearRegDiagnostic</span><span class="p">(</span><span class="n">big_model</span><span class="p">)</span>
<span class="n">residuos_plot</span><span class="o">.</span><span class="n">leverage_plot</span><span class="p">(</span><span class="n">high_leverage_threshold</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">cooks_threshold</span><span class="o">=</span><span class="s1">&#39;convention&#39;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/a146130ec9b386b7c2560ba804e8dd804d54d9d1bb1f6a63adaf8820b4582b44.png" src="../_images/a146130ec9b386b7c2560ba804e8dd804d54d9d1bb1f6a63adaf8820b4582b44.png" />
</div>
</div>
<p>Aquí, encontramos 31 ¡así que quizás eliminarlos ayude!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Filtering out influential points</span>
<span class="n">filtered_data</span> <span class="o">=</span> <span class="n">autompg</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="o">~</span><span class="n">influential_points</span><span class="p">]</span>

<span class="c1"># Fitting the model again</span>
<span class="n">big_model_fix</span> <span class="o">=</span> <span class="n">smf</span><span class="o">.</span><span class="n">ols</span><span class="p">(</span><span class="s1">&#39;mpg ~ disp * hp * domestic&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">filtered_data</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">stats</span><span class="o">.</span><span class="n">probplot</span><span class="p">(</span><span class="n">big_model_fix</span><span class="o">.</span><span class="n">resid</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="n">plt</span><span class="p">,</span> <span class="n">fit</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/56bf30bacd03ad19dcbce8b19a192a4970596163f9613119a58f7e8581ca4472.png" src="../_images/56bf30bacd03ad19dcbce8b19a192a4970596163f9613119a58f7e8581ca4472.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">shapiro_test_fix</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">shapiro</span><span class="p">(</span><span class="n">big_model_fix</span><span class="o">.</span><span class="n">resid</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Shapiro test statistic for fixed model: </span><span class="si">{</span><span class="n">shapiro_test_fix</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Shapiro test p-value for fixed model: </span><span class="si">{</span><span class="n">shapiro_test_fix</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Shapiro test statistic for fixed model: 0.9903539419174194
Shapiro test p-value for fixed model: 0.020681185647845268
</pre></div>
</div>
</div>
</div>
<p>La eliminación de estos puntos da como resultado un gráfico Q-Q mucho mejor, y ahora Shapiro-Wilk no rechaza un <span class="math notranslate nohighlight">\(\alpha\)</span> bajo.</p>
<p>Ahora hemos visto que a veces la modificación de los datos puede solucionar problemas con la regresión. Sin embargo, en la próxima lectura, en lugar de modificar los datos, vamos a modificar el modelo a través de <em>transformaciones</em>.</p>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./Week_8"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
                <footer class="bd-footer-article">
                  
<div class="footer-article-items footer-article__inner">
  
    <div class="footer-article-item"><!-- Previous / next buttons -->
<div class="prev-next-area">
    <a class="left-prev"
       href="8-0-Schedule_week_8.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">&lt;no title&gt;</p>
      </div>
    </a>
    <a class="right-next"
       href="8-2-transformations.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Lectura 8-2: Transformaciones</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div></div>
  
</div>

                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">Lectura 8-1: Diagnóstico de modelos</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#supuestos-del-modelo">Supuestos del modelo</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#comprobacion-de-supuestos">Comprobación de supuestos</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#grafico-de-ajuste-frente-a-residuos">Gráfico de ajuste frente a residuos</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#prueba-de-breusch-pagan">Prueba de Breusch-Pagan</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#histogramas">Histogramas</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#graficos-q-q">Gráficos Q-Q</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#prueba-de-shapiro-wilk">Prueba de Shapiro-Wilk</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#observaciones-inusuales">Observaciones inusuales</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#apalancamiento">Apalancamiento</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#valores-atipicos">Valores atípicos</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#influencia">Influencia</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#ejemplos-de-analisis-de-datos">Ejemplos de análisis de datos</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#buenos-diagnosticos">Buenos diagnósticos</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#diagnosticos-sospechosos">Diagnósticos sospechosos</a></li>
</ul>
</li>
</ul>

  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Alejandra Tabares
</p>

  </div>
  
  <div class="footer-item">
    
  <p class="copyright">
    
      © Copyright 2022.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=e353d410970836974a52"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>